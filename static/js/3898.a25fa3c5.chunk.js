"use strict";(self.webpackChunkn2_depot=self.webpackChunkn2_depot||[]).push([[3898],{39564:(e,t,i)=>{i.d(t,{Z:()=>f});var s=i(27366),r=(i(59486),i(84314)),n=i(11582),a=i(17768),o=i(46784),l=i(92026),d=i(49861),h=i(89125),c=(i(84936),i(93169),i(69912)),u=i(25243),p=i(848);let v=class extends((0,o.eC)(n.j)){constructor(e){super(e),this.observer=null,this.farDistance=1e3,this.heading=0,this.tilt=90,this.horizontalFieldOfView=45,this.verticalFieldOfView=45,this.feature=null}isValid(){return null!=this.observer&&this.farDistance>0}equals(e){return(0,l._W)(this.observer,e.observer)&&this.farDistance===e.farDistance&&this.heading===e.heading&&this.tilt===e.tilt&&this.horizontalFieldOfView===e.horizontalFieldOfView&&this.verticalFieldOfView===e.verticalFieldOfView&&(0,r.kk)(this.feature,e.feature)}};(0,s._)([(0,d.Cb)({type:p.Z,json:{write:!0}})],v.prototype,"observer",void 0),(0,s._)([(0,d.Cb)({type:Number,nonNullable:!0,range:{min:0},json:{write:{isRequired:!0}}})],v.prototype,"farDistance",void 0),(0,s._)([(0,d.Cb)({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}}),(0,h.p)((e=>a.BV.normalize((0,u.q9)(e),void 0,!0)))],v.prototype,"heading",void 0),(0,s._)([(0,d.Cb)({type:Number,nonNullable:!0,range:{min:0,max:180},json:{write:{isRequired:!0}}})],v.prototype,"tilt",void 0),(0,s._)([(0,d.Cb)({type:Number,nonNullable:!0,range:{min:0,max:360},json:{write:{isRequired:!0}}})],v.prototype,"horizontalFieldOfView",void 0),(0,s._)([(0,d.Cb)({type:Number,nonNullable:!0,range:{min:0,max:180},json:{write:{isRequired:!0}}})],v.prototype,"verticalFieldOfView",void 0),(0,s._)([(0,d.Cb)(r.rX)],v.prototype,"feature",void 0),(0,s._)([(0,d.Cb)({json:{read:!1}})],v.prototype,"isValid",null),v=(0,s._)([(0,c.j)("esri.analysis.Viewshed")],v);const f=v},84314:(e,t,i)=>{i.d(t,{NS:()=>c,kk:()=>l,pD:()=>d,rX:()=>h});var s=i(32035),r=i(12400),n=i(40885),a=i(54463),o=i(41781);function l(e,t){return d(e)===d(t)}function d(e){if(null==e)return null;const t=null!=e.layer?e.layer.id:"";let i=null;return i=null!=e.objectId?e.objectId:null!=e.layer&&"objectIdField"in e.layer&&null!=e.layer.objectIdField&&null!=e.attributes?e.attributes[e.layer.objectIdField]:e.uid,null==i?null:"o-".concat(t,"-").concat(i)}const h={json:{write:{writer:function(e,t){var i;null!=(null===e||void 0===e||null===(i=e.layer)||void 0===i?void 0:i.objectIdField)&&null!=e.attributes&&(t.feature={layerId:e.layer.id,objectId:e.attributes[e.layer.objectIdField]})},target:{"feature.layerId":{type:[Number,String]},"feature.objectId":{type:[Number,String]}}},origins:{"web-scene":{read:function(e){if(null!=e.layerId&&null!=e.objectId)return{uid:null,layer:{id:e.layerId,objectIdField:"ObjectId"},attributes:{ObjectId:e.objectId}}}}}}};function c(e,t,i,l){var h,c;const{sceneIntersectionHelper:p}=e,{observer:w,observerFeatureId:m,targetFeatureId:_,target:g}=i;if(null==m&&null==_)return;l||(l=e=>e),(0,s.a)(f,w,g);const b=(0,s.l)(f);(0,s.b)(f,w,f,1/b);const V=(0,n.zk)(f,g,v);t.options.store=a.eC.ALL,p.intersectToolIntersectorRay(V,t);let y=null,C=null,M=null,S=null;for(const s of t.results.all){var D,T;const t=(0,o.tB)(s,e);if(null==t||null==s.distanceInRenderSpace)continue;const i=d(t);null!=i&&(null!=m&&i===m&&(null!==(D=y)&&void 0!==D||(y=l(u(s,e,b))),s.distanceInRenderSpace-1<y&&(M=s)),null!=_&&i===_&&(null!==(T=C)&&void 0!==T||(C=l(u(s,e,b))),null==S&&s.distanceInRenderSpace-1<b&&b-s.distanceInRenderSpace+1<C&&(S=s)))}const{observerAdjusted:O,targetAdjusted:P}=i;null!==(h=M)&&void 0!==h&&h.getIntersectionPoint(O)?i.observerSurfaceNormal=M.getTransformedNormal((0,r.Ue)()):i.observerSurfaceNormal=null,null!==(c=S)&&void 0!==c&&c.getIntersectionPoint(P)?i.targetSurfaceNormal=S.getTransformedNormal((0,r.Ue)()):i.targetSurfaceNormal=null}function u(e,t,i){if((0,o._s)(e)){const s=(0,o.VB)(e,t);if(null!=s)return Math.min(s*p,i)}return 1e-5*i}const p=.05,v=(0,n.Ue)(),f=(0,r.Ue)()},95720:(e,t,i)=>{i.d(t,{V:()=>T,a:()=>R,b:()=>O});var s,r,n,a=i(30168),o=i(29134),l=i(7025),d=i(75831),h=i(24967),c=i(54943),u=i(85586),p=i(76284),v=i(24842),f=i(27193),w=i(13773),m=i(82999),_=i(49450),g=i(58406),b=i(699),V=i(99339),y=i(98634),C=i(8654),M=i(78928),S=i(64201),D=i(19253);class T extends p.c{constructor(){super(...arguments),this.shadowMap={depthTexture:null,nearFar:[1,100],numActiveFaces:1,atlasRegions:[[0,0,1,1]]},this.targetVector=[1,0,0],this.upVector=[0,0,1],this.fovs=[45,45],this.headingAndTilt=[0,0],this.observerOffset=[0,0,0],this.projectionMatrices=l.Wd.flat(),this.viewMatrices=l.Wd.flat(),this.volumeOffset=0}}function O(){const e=new S.kG,t=e.fragment;return e.include(h.k),e.include(p.u),e.include(f.r),e.include(d.R),t.include(c.K),t.include(v.f),e.include(u.e),t.uniforms.add(new D.A("depthTexture",((e,t)=>{var i;return null===(i=t.depth)||void 0===i?void 0:i.attachment})),new C.g("inverseProjectionMatrix",((e,t)=>t.camera.inverseProjectionMatrix)),new C.g("inverseViewNormalMatrix",((e,t)=>(0,o.iS)(P,t.camera.viewInverseTransposeMatrix))),new _.J("viewshedObserverOffset",(e=>e.observerOffset)),new _.J("viewshedTargetVector",(e=>e.targetVector)),new _.J("viewshedUpVector",(e=>e.upVector)),new m.A("viewshedFOVs",(e=>e.fovs)),new m.A("viewshedHeadingAndTilt",(e=>e.headingAndTilt)),new m.A("viewshedNearFar",(e=>{var t;return null!==(t=e.shadowMap.nearFar)&&void 0!==t?t:[1,100]})),new g.p("viewshedVolumeOffset",(e=>e.volumeOffset)),new D.A("viewshedShadowMap",(e=>e.shadowMap.depthTexture)),new M.G("viewshedProjectionMatrices",(e=>e.projectionMatrices),6),new M.G("viewshedViewMatrices",(e=>e.viewMatrices),6),new V._("viewshedNumFaces",(e=>e.shadowMap.numActiveFaces)),new b.O("viewshedAtlasRegions",(e=>e.shadowMap.atlasRegions.flat()),24),new D.A("normalMap",((e,t)=>e.normals)),new w.U("useNormalMap",((e,t)=>null!=e.normals))),t.constants.add("visibleColor","vec4",[0,1,0,.5]),t.constants.add("occludedColor","vec4",[1,0,0,.5]),t.code.add((0,y.H)(s||(s=(0,a.Z)(["vec3 normalFromTexture() {\nvec4 norm4 = texture(normalMap, uv);\nvec3 nNormal = vec3(-1.0) + 2.0 * norm4.xyz;\nreturn normalize((inverseViewNormalMatrix * vec4(nNormal, 1.0)).xyz);\n}"])))).code.add((0,y.H)(r||(r=(0,a.Z)(["vec2 getViewshedUv(vec4 worldPosition, int face) {\nmat4 viewshedMatrix = viewshedProjectionMatrices[face];\nvec4 viewshedUv4 = viewshedMatrix * worldPosition;\nvec3 viewshedUv = viewshedUv4.xyz / viewshedUv4.w;\nreturn viewshedUv.xy;\n}\nfloat viewshedDepthToFloat(float depth) {\nreturn (depth - viewshedNearFar[0]) / (viewshedNearFar[1] - viewshedNearFar[0]);\n}\nfloat getOrthographicDepthToViewshed(vec4 worldPosition, int face) {\nmat4 viewshedViewMatrix = viewshedViewMatrices[face];\nvec4 viewshedUv4 = viewshedViewMatrix * worldPosition;\nvec3 viewshedUv = viewshedUv4.xyz / viewshedUv4.w;\nfloat depth = -viewshedUv.z;\nreturn viewshedDepthToFloat(depth);\n}\nfloat getDepthFromShadowMap(vec2 uv, int face) {\nint index = 4 * face;\nfloat umin = viewshedAtlasRegions[index];\nfloat umax = viewshedAtlasRegions[index + 1];\nfloat vmin = viewshedAtlasRegions[index + 2];\nfloat vmax = viewshedAtlasRegions[index + 3];\nvec4 atlasRegion = vec4(umin, vmin, umax, vmax);\nreturn rgba4ToFloat(textureAtlasLookup(viewshedShadowMap, uv, atlasRegion));\n}\nstruct ViewshedPoint {\nint face;\nvec2 uv;\nbool isWithin;\nfloat orthographicDepth;\n};\nmat3 rotationMatrix(vec3 axis, float angle)\n{\nfloat s = sin(angle);\nfloat c = cos(angle);\nfloat oc = 1.0 - c;\nreturn mat3(\noc * axis.xxz * axis.xyx + vec3(c, axis.zy) * vec3(1., -s, s),\noc * axis.xyy * axis.yyz + vec3(axis.z, c, axis.x) * vec3(s, 1., -s),\noc * axis.zyz * axis.xzz + vec3(axis.yx, c) * vec3(-s, s, 1.)\n);\n}\nfloat distanceToPlane(vec3 position, vec3 normal) {\nreturn dot(position, normal);\n}\nbool outsideViewshed(float distance) {\nreturn distance > -viewshedVolumeOffset;\n}\nbool isWithinViewshed(vec3 position) {\nfloat positionLength = length(position - viewshedObserverOffset);\nfloat farSphereDistance = positionLength - viewshedNearFar[1];\nif (outsideViewshed(farSphereDistance)) { return false; }\nfloat nearSphereDistance = viewshedNearFar[0] - positionLength;\nif (outsideViewshed(nearSphereDistance)) { return false; }\nvec3 westVector = normalize(cross(viewshedUpVector, viewshedTargetVector));\nbool leftOfTarget = distanceToPlane(position, westVector) > 0.0;\nif (viewshedFOVs[0] < TWO_PI) {\nfloat horAngle = viewshedFOVs[0] / 2.0;\nhorAngle = leftOfTarget ? horAngle : -horAngle;\nvec3 sideVector = viewshedTargetVector * rotationMatrix(viewshedUpVector, horAngle);\nbool inFront = distanceToPlane(position, sideVector) > 0.0;\nif (inFront) {\nvec3 sideNormal = cross(viewshedUpVector, sideVector) * (leftOfTarget ? 1. : -1.);\nfloat sideDistance = distanceToPlane(position, normalize(sideNormal));\nif (outsideViewshed(sideDistance)) { return false; }\n} else if (viewshedFOVs[0] < PI) { return false; }\n}\nif (viewshedFOVs[1] < PI) {\nfloat t = dot(viewshedUpVector, position);\nvec3 nProjVector = normalize(position - t * viewshedUpVector);\nfloat heading = acos(clamp(dot(normalize(viewshedTargetVector), nProjVector), -1.0, 1.0));\nheading = leftOfTarget ? heading : -heading;\nbool aboveTarget = distanceToPlane(position, viewshedUpVector) > 0.0;\nfloat verFOV = viewshedFOVs[1] / 2.0;\nverFOV = aboveTarget ? -verFOV : verFOV;\nmat3 rotateByHeading = rotationMatrix(viewshedUpVector, heading);\nvec3 sideVector = viewshedTargetVector * rotationMatrix(westVector, verFOV) * rotateByHeading;\nvec3 leftVector = westVector * rotateByHeading;\nvec3 sideNormal = cross(sideVector, leftVector) * (aboveTarget ? 1. : -1.);\nfloat sideDistance = distanceToPlane(position, normalize(sideNormal));\nif (outsideViewshed(sideDistance)) { return false; }\n}\nreturn true;\n}\nbool getViewshedPoint(vec4 localPosition, out ViewshedPoint point) {\nfor(int i=0; i < viewshedNumFaces; i++) {\nvec2 viewshedUv = getViewshedUv(localPosition, i);\nif (viewshedUv.x > 0. && viewshedUv.x < 1. && viewshedUv.y > 0. && viewshedUv.y < 1.) {\nfloat orthoDepth = getOrthographicDepthToViewshed(localPosition, i);\nif (orthoDepth >= 0.) {\nbool isWithin = isWithinViewshed(localPosition.xyz);\npoint = ViewshedPoint(i, viewshedUv, isWithin, orthoDepth);\nreturn true;\n}\n}\n}\nreturn false;\n}\nfloat normalCosAngle(float linearDepth, vec3 localPosition) {\nvec3 viewingDir = normalize(localPosition);\nif(useNormalMap) {\nvec3 normal = normalFromTexture();\nreturn dot(normal, viewingDir);\n}\nvec3 cameraSpacePosition = reconstructPosition(gl_FragCoord.xy, linearDepth);\nvec3 normal = normalFromDepth(depthTexture, cameraSpacePosition, gl_FragCoord.xy, uv);\nnormal = (inverseViewNormalMatrix * vec4(normal, 1.0)).xyz;\nreturn dot(normal, viewingDir);\n}"])))),t.main.add((0,y.H)(n||(n=(0,a.Z)(["float depth = depthFromTexture(depthTexture, uv);\nif (depth >= 1.0 || depth <= 0.0) {\nreturn;\n}\nfloat linearDepth = linearizeDepth(depth);\nvec4 localPosition = reconstructLocalPosition(gl_FragCoord.xy, linearDepth);\nViewshedPoint point;\nbool foundFace = getViewshedPoint(localPosition, point);\nif (!foundFace || !point.isWithin) {\nreturn;\n}\nfloat viewshedDepth = getDepthFromShadowMap(point.uv, point.face);\nfloat distance = point.orthographicDepth;\nbool visible = distance < viewshedDepth;\nfragColor = visible ? visibleColor : occludedColor;\nfloat cosAngle = normalCosAngle(linearDepth, localPosition.xyz);\nfloat threshold = useNormalMap ? -0.01 : -0.04;\nif (cosAngle > threshold) {\nfragColor = occludedColor;\n}"])))),e}const P=(0,l.Ue)(),R=Object.freeze(Object.defineProperty({__proto__:null,ViewshedPassParameters:T,build:O},Symbol.toStringTag,{value:"Module"}))},98074:(e,t,i)=>{i.d(t,{p:()=>l});var s=i(27366),r=i(42537),n=i(67426),a=i(49861),o=(i(93169),i(32718),i(84936),i(69912));const l=e=>{let t=class extends((0,n.v)(e)){constructor(){super(...arguments),this.parent=null,this._userInteractive=!1,this._interactiveViewModelCount=0}get interactive(){return this._interactiveViewModelCount>0||this._userInteractive}set interactive(e){this._userInteractive=e}get updating(){return!1}get visible(){return null==this.parent||this.parent.visible&&!this.parent.suspended}set visible(e){this._overrideIfSome("visible",e)}forceInteractiveForViewModel(){return this._interactiveViewModelCount++,(0,r.kB)((()=>this._interactiveViewModelCount--))}};return(0,s._)([(0,a.Cb)({constructOnly:!0})],t.prototype,"parent",void 0),(0,s._)([(0,a.Cb)({constructOnly:!0})],t.prototype,"view",void 0),(0,s._)([(0,a.Cb)({type:Boolean})],t.prototype,"interactive",null),(0,s._)([(0,a.Cb)()],t.prototype,"_userInteractive",void 0),(0,s._)([(0,a.Cb)({readOnly:!0})],t.prototype,"updating",null),(0,s._)([(0,a.Cb)()],t.prototype,"visible",null),(0,s._)([(0,a.Cb)()],t.prototype,"_interactiveViewModelCount",void 0),t=(0,s._)([(0,o.j)("esri.views.3d.analysis.AnalysisView3D")],t),t}},3319:(e,t,i)=>{i.d(t,{AN:()=>h,C7:()=>y,Ci:()=>P,Eu:()=>V,G0:()=>p,GI:()=>a,GW:()=>b,K_:()=>C,L0:()=>l,Lf:()=>w,Mr:()=>o,P3:()=>c,QG:()=>M,Qf:()=>T,Wp:()=>u,XC:()=>d,Yn:()=>D,ZE:()=>v,ae:()=>R,cf:()=>S,fg:()=>m,sz:()=>_,tW:()=>n,tv:()=>g,v9:()=>f,yy:()=>O});var s=i(93169),r=i(16889);const n=(0,s.Z)("mac")?"Meta":"Control",a="Shift",o=2,l=1.15,d=1.15,h=2500,c=.02,u=Math.cos((0,r.Vl)(45)),p=Math.cos((0,r.Vl)(5)),v=.95,f=.3,w=2,m=1,_=3,g=11,b=22.5,V=40,y=48,C=2.25,M=4,S=1,D=.3,T=6,O=4,P=1600,R=.4},92030:(e,t,i)=>{i.r(t),i.d(t,{default:()=>Qt});var s=i(27366),r=i(84314),n=i(7138),a=i(93169),o=i(32718),l=i(92026),d=i(94172),h=i(49861),c=(i(84936),i(69912)),u=i(32035),p=i(12400),v=i(79803),f=i(98074),w=i(33906),m=i(42537),_=i(51995),g=i(84652),b=i(16889),V=i(29134),y=i(7025),C=i(68401),M=i(56529);const S=(0,b.Vl)(2);const D=new class{constructor(){this.collisionRadius=5,this.fovUnfocusedArcWidth=4,this.fovFocusedArcWidth=2*this.fovUnfocusedArcWidth,this.scaleOrientSize=90,this.scaleOrientHandleRadius=.025,this.scaleOrientMinDistance=1,this.scaleOrientArrowTipLength=.3,this.scaleOrientArrowTipFocusMultiplier=2/1.5,this.observerSize=5,this.hoverTimeoutMilliseconds=1e3,this.viewAngleThreshold=10}getFovArcWidth(e){return e?this.fovFocusedArcWidth:this.fovUnfocusedArcWidth}getScaleOrientArrowTipLength(e){return this.scaleOrientArrowTipLength*(e?this.scaleOrientArrowTipFocusMultiplier:1)}};const T=new class{constructor(){this.frameWidthNotSelected=.3,this.frameWidthSelected=1,this.frameColor=new _.Z([255,255,255,.99]),this.observerPointConfiguration={size:6,pixelSnappingEnabled:!1,primitive:"circle",elevationInfo:{mode:"absolute-height",offset:0},outlineSize:0,color:_.Z.toUnitRGBA(new _.Z([3,252,111,1]))},this.shapeMaterialParameters={color:[.33,.33,.33,.25],renderOccluded:M.yD.Occlude,cullFace:C.Vr.Back,writeDepth:!1}}};i(59486);var O=i(39564),P=i(55652),R=i(63780),A=i(14921),x=i(17768),U=i(66978),E=i(50951),F=i(100),I=i(82218),H=i(83639),z=i(51328),L=i(21289),k=i(71917);function j(e,t){let{tiltedUpVector:i,rightVector:s,observerRenderSpace:r}=e;const n=(0,H.Aq)(i,s,r,t);return n[12]=0,n[13]=0,n[14]=0,n}function N(e,t,i,s){const r=(0,p.Ue)(),n=(0,P.st)(i.plane),a=function(e,t){const i=B;e.renderCoordsHelper.toRenderCoords(e.camera.position,i);const s=(0,L.kE)(e,i,e.camera.heading,e.camera.tilt,(0,k.dp)()).direction;return(0,b.BV)((0,u.r)(s,t))-90}(t,n);let o;if(Math.abs(a)>D.viewAngleThreshold)o=e.next((0,z._N)(t,i.plane));else{const r=(0,P.Yq)(s.targetRenderSpace,i.basis1,(0,P.Ue)()),n=(0,u.n)(B,i.basis1),a=(0,u.n)(G,i.basis2);o=e.next((0,z._N)(t,r)).next((e=>{const t=e=>{const t=(0,u.f)((0,u.a)(W,e,i.origin),a),r=Math.acos((0,b.uZ)(t/s.farDistanceRenderSpace,-1,1)),o=Math.sin(r)*s.farDistanceRenderSpace;return(0,u.g)((0,p.Ue)(),i.origin,(0,u.g)((0,p.Ue)(),(0,u.h)(W,n,o),(0,u.h)(Y,a,t)))},r=t(e.renderStart),o=t(e.renderEnd);return{...e,renderStart:r,renderEnd:o}}))}return o.next((e=>{"start"===e.action&&(0,u.c)(r,e.renderStart);const t=(0,b.BV)((0,H.Gd)(r,e.renderEnd,i.origin,n));return{...e,deltaAngle:t}}))}function Z(e,t,i,s){return(0,V.Us)(q,i,s),(0,u.t)(e,t,q)}const B=(0,p.Ue)(),G=(0,p.Ue)(),W=(0,p.Ue)(),Y=(0,p.Ue)(),q=(0,y.Ue)();var X=i(35284),Q=i(40508),K=i(41029),J=i(68650),$=i(70619),ee=i(97731),te=i(58901),ie=i(74229),se=i(99034);class re extends J.w{constructor(e){super(),this._handles=new F.Z,this._tool=e.tool,this._view=e.view,this._focusedArcMaterial=this._createArcMaterial(!0),this._unfocusedArcMaterial=this._createArcMaterial(!1),this._createManipulators(),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}destroy(){this._handles=(0,l.SC)(this._handles),this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()})),this._tool=null,this._view=null,this._manipulators=null}createDragPipeline(e,t){const i=Object.values(this._manipulators);return(0,m.AL)(i.map((i=>{let{manipulator:s,side:r}=i;return(0,ie.Xd)(s,((i,s,n,a,o)=>{const l=function(e,t){let{observerRenderSpace:i,targetRenderSpace:s,tiltedUpVector:r,rightVector:n,farDistanceRenderSpace:a}=t;const o=(0,u.a)(le,s,i),l=ne(e)?n:r,d=(0,u.h)(de,l,a);return(0,I.f)(i,o,d)}(r,t),d=s.next((e=>({...e,manipulatorType:K.d.SCALE,side:r}))),h=N(d,this._view,l,t);e(i,h,n)}))})))}updateManipulatorsTransform(e){e.arcCentersPoints(he),this._forEachManipulatorInfo((t=>this._updateArcManipulatorTransform(t,e,he[t.side])))}updateManipulatorVisuals(e){this._forEachManipulatorInfo((t=>this._updateArcManipulatorVisuals(t,e)))}_updateArcManipulatorVisuals(e,t){let{manipulator:i,side:s}=e;const r=[];if(null!=t){const[e,n]=function(e,t,i){const{horizontalFieldOfView:s,verticalFieldOfView:r}=t,n=ne(e),a=(0,b.Vl)((0,b.uZ)((n?r:s)/2,0,15)),o=function(e,t,i){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:10;(0,ee.hu)(s>1,"createArcPolylineGeometry() needs at least 2 for numVertices");const r=t-e;if(r<=0||i<=0){const e=.01;return[(0,p.al)(0,0,e),(0,p.al)(0,0,-e)]}const n=[],a=r/s;for(let o=0;o<s;o++){let r=e+o*a;o===s-1&&(r=t);const l=Math.cos(r)*i,d=Math.sin(r)*i,h=(0,p.al)(l-i,0,d);n.push(h)}return n}(-a/2,a/2,n?1:Math.max(Math.sin((0,b.Vl)(90-r/2)),.1));return[(0,$.rh)(i,o),o]}(s,t,this._unfocusedArcMaterial);r.push(new Q.r(e,se.Q9.Unfocused),new Q.r(e.instantiate({material:this._focusedArcMaterial}),se.Q9.Focused)),i.collisionType={type:"line",paths:[n]}}i.renderObjects=r,i.radius=D.collisionRadius}_updateArcManipulatorTransform(e,t,i){let{manipulator:s,side:r}=e;const n=t.horizontalFieldOfView,a=(0,b.Vl)(t.verticalFieldOfView/2),o=(0,b.Vl)(n/2),l=ne(r);s.renderLocation=i;const d=(0,y.Ue)(),h=e=>{(0,V.Jp)(d,e,d)};h((0,V.gT)(oe,(0,b.Vl)(-90))),l||h((0,V.aC)(oe,a));const c=t.farDistanceRenderSpace;let p,v;h((0,V.xJ)(oe,(0,u.i)(le,c,c,c))),h((0,V.QO)(oe,function(e){return function(e){switch(e){case"left":return 0;case"bottom":return 1;case"right":return 2;case"top":return 3}}(e)*ae}(r))),h(j(t,oe)),l?(p=o,v=t.tiltedUpVector):(v=t.rightVector,p=a),p*="right"===r||"bottom"===r?-1:1;const f=(0,V.Us)(oe,p,v);null!=f&&h(f),s.modelTransform=d}_createManipulators(){const e=this._createArcManipulator("left"),t=this._createArcManipulator("right"),i=this._createArcManipulator("top"),s=this._createArcManipulator("bottom");this._manipulators={left:e,right:t,top:i,bottom:s},[[s.manipulator,i.manipulator],[e.manipulator,t.manipulator]].forEach((e=>{let[t,i]=e;t.metadata={pairedManipulator:i},i.metadata={pairedManipulator:t}}))}_createArcManipulator(e){const t=new X.Z({view:this._view,autoScaleRenderObjects:!1,worldSized:!0}),i={manipulator:t,side:e};return this._updateArcManipulatorVisuals(i),this._handles.add(t.events.on("focus-changed",(e=>{var i;const s=null===(i=t.metadata)||void 0===i?void 0:i.pairedManipulator;null!=s&&(s.hovering!==t.hovering&&(s.hovering=t.hovering),s.grabbing!==t.grabbing&&(s.grabbing=t.grabbing))}))),i}_createArcMaterial(e){const t=D.getFovArcWidth(e),i=new te.U({renderOccluded:M.yD.OccludeAndTransparent,isDecoration:!0,width:t});return this._handles.add((0,d.YP)((()=>_.Z.toUnitRGBA(this._view.effectiveTheme.accentColor)),(e=>i.setParameters({color:e})),d.nn)),i}forEachManipulator(e){Object.values(this._manipulators).forEach((t=>{let{manipulator:i}=t;return e(i,K.d.SCALE)}))}_forEachManipulatorInfo(e){Object.values(this._manipulators).forEach((t=>e(t)))}get test(){return{manipulators:this._manipulators}}}function ne(e){return"left"===e||"right"===e}const ae=Math.PI/2,oe=(0,y.Ue)(),le=(0,p.Ue)(),de=(0,p.Ue)(),he={top:(0,p.Ue)(),bottom:(0,p.Ue)(),left:(0,p.Ue)(),right:(0,p.Ue)()};var ce=i(40885),ue=i(3319),pe=i(66832);class ve extends X.Z{constructor(e,t){super({view:e,autoScaleRenderObjects:!1,worldSized:!1,radius:D.collisionRadius}),this._handles=new F.Z,this._setupManipulatorVisual(t)}destroy(){this._handles.remove(),super.destroy()}_setupManipulatorVisual(e){const t=this._createMaterial(),i=[(0,p.al)(0,0,0),(0,p.al)(0,0,1)],s=(0,$.PD)(t,i,e,16,!1),r=(0,$.PD)(t,i,e*ue.Mr,16,!1),n=fe(!1,t,e),a=fe(!0,t,e),o=(0,y.Ue)();(0,V.vc)(o,i[i.length-1]),(0,V.dC)(o,o,(0,V.aC)(we,Math.PI/2)),(0,V.dC)(o,o,(0,V.gT)(we,Math.PI/2)),n.transformation=o,a.transformation=o,this.renderObjects=[new Q.r(s,se.Q9.Unfocused),new Q.r(r,se.Q9.Focused),new Q.r(n,se.Q9.Unfocused),new Q.r(a,se.Q9.Focused)];const l=(0,p.al)(0,D.getScaleOrientArrowTipLength(!0),0),d=(0,u.t)(l,l,o),h=[...i,d];this.collisionType={type:"line",paths:[h]}}_createMaterial(){const e=new pe.E({cullFace:C.Vr.Back,renderOccluded:M.yD.OccludeAndTransparent,isDecoration:!0});return this._handles.add((0,d.YP)((()=>_.Z.toUnitRGBA(this.view.effectiveTheme.accentColor)),(t=>e.setParameters({color:t})),d.nn)),e}}function fe(e,t,i){const s=D.getScaleOrientArrowTipLength(e);let r=2*i;e&&(r*=ue.Mr);const n=s/2;return(0,$.DA)(t,s,n,n,r,0)}const we=(0,y.Ue)();var me=i(89107);class _e extends J.w{constructor(e){super(),this._handles=new F.Z,this._tool=e.tool,this._view=e.view;const t=D.scaleOrientHandleRadius;this._manipulatorHeading=new ve(this._view,t),this._manipulatorTilt=new ve(this._view,t),this._manipulatorDistance=new ve(this._view,t),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}destroy(){this._handles.destroy(),this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()})),this._manipulatorHeading=null,this._manipulatorTilt=null,this._manipulatorDistance=null,this._tool=null,this._view=null}createHeadingDragPipeline(e,t){return(0,ie.Xd)(this._manipulatorHeading,((i,s,r,n,a)=>{const o=this._view,{tiltParallelToSurface:l,farDistanceRenderSpace:d,upVector:h,observerRenderSpace:c,targetRenderSpace:p,rightVector:v}=t,f=Math.sin((0,b.Vl)(l))*d,w=(0,u.g)(Ve,c,(0,u.h)(ye,h,f)),m=(0,u.a)(ye,p,w),_=(0,u.h)(Ce,v,(0,u.G)(m)),g=N(s,o,(0,I.f)(w,m,_),t).next((e=>({...e,manipulatorType:K.d.ROTATE})));e(i,g,r)}))}createTiltDragPipeline(e,t){return(0,ie.Xd)(this._manipulatorTilt,((i,s,r,n,a)=>{const{observerRenderSpace:o,farDistanceRenderSpace:l,upVector:d,targetDirection:h}=t,c=(0,u.f)(h,d),p=(0,u.b)(Ve,h,d,-c);(0,u.h)(p,(0,u.n)(p,p),l);const v=(0,u.h)(ye,d,l),f=(0,I.f)(o,p,v),w=N(s,this._view,f,t).next((e=>({...e,manipulatorType:K.d.ROTATE})));e(i,w,r)}))}createDistanceDragPipeline(e,t){return(0,ie.Xd)(this._manipulatorDistance,((i,s,r,n,a)=>{const o=(0,ce.al)(t.observerRenderSpace,t.targetDirection),l=s.next((0,ie.kY)(this._view,i.location)).next((0,z.B2)(this._view,o)).next((e=>({...e,manipulatorType:K.d.SCALE})));e(i,l,r)}))}updateManipulators(e){const{targetRenderSpace:t}=e;this._manipulatorHeading.renderLocation=t,this._manipulatorTilt.renderLocation=t,this._manipulatorDistance.renderLocation=t;const i=(0,y.Ue)(),s=e=>{(0,V.Jp)(i,e,i)},r=D.scaleOrientSize*(me.E5/me.dB);s((0,V.xJ)(ge,(0,u.i)(Ve,r,r,r))),s(j(e,ge));const n=D.scaleOrientHandleRadius*ue.Mr*r,a=(0,u.h)(Ve,e.targetDirection,n);s((0,V.vc)(ge,a));const o=(0,V.QO)(ge,-Me);(0,V.dC)(o,o,(0,V.gT)(be,-Me)),this._manipulatorHeading.modelTransform=(0,V.dC)((0,y.Ue)(),i,o);const l=(0,V.gT)(ge,Me);(0,V.dC)(l,l,(0,V.QO)(be,Math.PI)),this._manipulatorTilt.modelTransform=(0,V.Jp)((0,y.Ue)(),i,l),this._manipulatorDistance.modelTransform=i}forEachManipulator(e){e(this._manipulatorHeading,K.d.ROTATE),e(this._manipulatorTilt,K.d.ROTATE),e(this._manipulatorDistance,K.d.SCALE)}}const ge=(0,y.Ue)(),be=(0,y.Ue)(),Ve=(0,p.Ue)(),ye=(0,p.Ue)(),Ce=(0,p.Ue)(),Me=Math.PI/2;i(75505),i(86741),i(51370),i(10064);class Se extends X.Z{constructor(e,t){super({view:e,autoScaleRenderObjects:!1,worldSized:!1,radius:D.observerSize,interactive:!1}),this._handles=new F.Z;const i=(0,H.EA)(this._color);this.renderObjects=[new Q.r((0,$.PI)(i,D.observerSize,32,32))],t.manipulators.add(this),this._handles.add([(0,d.YP)((()=>this._color),(e=>{i.setParameters({color:e})}),d.nn)])}destroy(){this._handles.remove(),super.destroy()}get _color(){return _.Z.toUnitRGBA(this.view.effectiveTheme.accentColor)}}(0,s._)([(0,h.Cb)()],Se.prototype,"_color",null);var De=i(6599),Te=i(17877);const Oe=Symbol("dragHandles"),Pe=Symbol("hideManipulators"),Re=Symbol("hideFoVManipulators"),Ae=Symbol("hideObserverManipulator");let xe=class extends n.Z{constructor(e){super(e),this._moveManipulation=null,this._observerManipulator=null,this._fieldOfViewManipulation=null,this._scaleOrientManipulation=null,this._forceHoveringTask=null,this._forceHoveringTestPromise=null,this._grabbing=!1,this.viewshedComputedData=null}initialize(){this._moveManipulation=this._createMoveManipulation(),this._fieldOfViewManipulation=new re({view:this.view,tool:this.parentTool}),this._scaleOrientManipulation=new _e({view:this.view,tool:this.parentTool}),this._observerManipulator=new Se(this.view,this.parentTool),this.addHandles([(0,d.YP)((()=>{var e;return null===(e=this.viewshedComputedData)||void 0===e?void 0:e.observerRenderSpace}),(e=>{null!=e&&(this._moveManipulation.renderLocation=e,this._observerManipulator.renderLocation=e)}),d.tX),(0,d.YP)((()=>{var e;return null===(e=this.viewshedComputedData)||void 0===e?void 0:e.heading}),(e=>{e&&(this._moveManipulation.angle=(0,b.Vl)(90-e))}),d.nn),(0,d.YP)((()=>{const{viewshedComputedData:e}=this;return{viewshedComputedData:e,observer:null===e||void 0===e?void 0:e.observer}}),((e,t)=>{let{viewshedComputedData:i,observer:s}=e;this._grabbing&&s!==(null===t||void 0===t?void 0:t.observer)||(this.removeHandles(Oe),(null===i||void 0===i?void 0:i.isValid())&&this.addHandles([this._buildObserverDragPipeline(i),this._buildFOVDragPipeline(i),this._buildScaleOrientDragPipeline(i)].filter(R.pC),Oe))}),d.nn),(0,d.YP)((()=>{const e=this.viewshedComputedData;return null!==e&&void 0!==e&&e.isValid()?{viewshedCompData:e,target:e.targetRenderSpace,hFOV:e.horizontalFieldOfView,vFOV:e.verticalFieldOfView}:null}),(e=>{null!=e&&this._fieldOfViewManipulation.updateManipulatorsTransform(e.viewshedCompData)}),d.nn),(0,d.YP)((()=>{const e=this.viewshedComputedData;return null!==e&&void 0!==e&&e.isValid()?{viewshedCompData:e,hFOV:e.horizontalFieldOfView,vFOV:e.verticalFieldOfView,tilt:e.tilt}:null}),(e=>{null!=e&&this._fieldOfViewManipulation.updateManipulatorVisuals(e.viewshedCompData)}),d.nn),(0,d.YP)((()=>{var e,t;const i=this.analysisViewData.visible&&null!==(e=null===(t=this.viewshedComputedData)||void 0===t?void 0:t.isValid())&&void 0!==e&&e,s=this.parentTool.selectedViewshedComputedData===this.viewshedComputedData;return{fovManipulationAvailable:i&&!this.parentTool.isPlacingTarget,nonFOVManipulationAvailable:i&&(!this.parentTool.creating||s)}}),(e=>{let{fovManipulationAvailable:t,nonFOVManipulationAvailable:i}=e;this._moveManipulation.available=i,this._scaleOrientManipulation.available=i,this._observerManipulator.available=i,this._fieldOfViewManipulation.available=t}),d.nn),(0,d.YP)((()=>{const e=this.viewshedComputedData;if(null===e||void 0===e||!e.isValid())return null;const{observer:t,target:i,verticalFieldOfView:s,horizontalFieldOfView:r}=e;return{viewshedCompData:e,observer:t,target:i,verticalFieldOfView:s,horizontalFieldOfView:r}}),(e=>{null!=e&&this._scaleOrientManipulation.updateManipulators(e.viewshedCompData)}),d.nn)]);this._forEachManipulator((e=>{const t=this.analysisViewData;this.addHandles([e.events.on("focus-changed",(()=>{const e=this._someManipulatorHovering();e&&this.parentTool.subToolHandles.forEach((e=>{let{subTool:t}=e;t._resetHoveringTask()})),this._someManipulatorSelected()||e||(this._forceHoveringTask=(0,A.vr)((async e=>{var t;await(null!==(t=this._forceHoveringTestPromise)&&void 0!==t?t:(0,U.e4)(D.hoverTimeoutMilliseconds,e)),(0,U.k_)(e),this._forceHoveringTask=null,this._updateManipulatorVisibility()})))})),e.events.on("grab-changed",(i=>{var s;this._grabbing="start"===i.action,"end"===i.action&&null!==(s=t.tool)&&void 0!==s&&s.updateInteractionVisualsVisibility(),this.parentTool.subToolHandles.forEach((e=>{let{subTool:t}=e;t!==this&&t._setInteractive(!this._grabbing)})),this._setInteractive((t=>t.hasManipulator(e)||!this._grabbing))})),e.events.on("drag",(e=>{var i;"start"===e.action&&(null===(i=t.tool)||void 0===i||i.updateInteractionVisualsVisibility())}))])}))}destroy(){this._forceHoveringTask=(0,l.IM)(this._forceHoveringTask),this._moveManipulation=(0,l.SC)(this._moveManipulation),this._fieldOfViewManipulation=(0,l.SC)(this._fieldOfViewManipulation),this._scaleOrientManipulation=(0,l.SC)(this._scaleOrientManipulation),this.parentTool.manipulators.remove(this._observerManipulator),this._observerManipulator=(0,l.SC)(this._observerManipulator)}get viewshed(){var e;return null===(e=this.viewshedComputedData)||void 0===e?void 0:e.viewshed}get grabbing(){return this._grabbing}get observer(){var e;return null===(e=this.viewshed)||void 0===e?void 0:e.observer}set observer(e){const t=this.viewshed;null!=t&&(t.observer=e)}get discManipulator(){return this._moveManipulation.xyManipulation.discManipulator}get moveInteractionState(){const{dragging:e,grabbing:t}=this._moveManipulation;return{dragging:e,grabbing:t}}get scaleOrientInteractionState(){const{dragging:e,grabbing:t}=this._scaleOrientManipulation;return{dragging:e,grabbing:t}}_setInteractive(e){const t="boolean"==typeof e;this._forEachManipulation((i=>i.interactive=t?e:e(i)))}onManipulatorSelectionChanged(){this._updateManipulatorVisibility(),this._someManipulatorSelected()||(this.analysisViewData.selectedViewshed===this.viewshed&&(this.analysisViewData.selectedViewshed=null),this._resetHoveringTask())}hasManipulator(e){let t=!1;return this._forEachManipulator((i=>{t=t||i===e})),t}_someManipulatorSelected(){return this._moveManipulation.selected||this._fieldOfViewManipulation.selected||this._scaleOrientManipulation.selected}_someManipulatorHovering(){return this._moveManipulation.hovering||this._fieldOfViewManipulation.hovering||this._scaleOrientManipulation.hovering}_createMoveManipulation(){return new De.b({view:this.view,tool:this.parentTool,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:me.E5})}_buildObserverDragPipeline(e){const t=e.observer;if(null==t)return null;const i=this.view.spatialReference;return this._moveManipulation.createDragPipeline(((e,s,r,n,a)=>{n=n.next((0,ie.di)(this,["observer"]));const o=(0,v.tryProjectWithZConversion)(t,i);if(null==o)return{steps:r,cancel:n};const l=Te.c.fromGeometry(o,(0,E.wg)(this.view.viewingMode));return{steps:r.next((0,ie.$Q)({operations:l})).next((e=>(this.observer=l.data.geometry,e))),cancel:n}}),{mode:"absolute-height",offset:0},i,void 0)}_buildFOVDragPipeline(e){let t=0,i=0;return this._fieldOfViewManipulation.createDragPipeline(((s,r,n)=>{if(null==e)return{steps:r,cancel:n};const a=e.viewshed;let o=null;return n=n.next((0,ie.di)(e,["horizontalFieldOfView","verticalFieldOfView"])),{steps:r.next((s=>{if("start"===s.action)return o=null,t=e.horizontalFieldOfView,i=e.verticalFieldOfView,s;const r=s.deltaAngle;if(null==o&&0!==r){const e="bottom"===s.side||"left"===s.side?r>0:r<0;o=ne(s.side)?0===t&&e||360===t&&!e:0===i&&e}const n=o?function(e){return"left"===e?"right":"right"===e?"left":"top"===e?"bottom":"top"}(s.side):s.side;let l=0;switch(n){case"left":l=t/2-r;break;case"right":l=t/2+r;break;case"top":l=i+2*r;break;case"bottom":l=i-2*r}return ne(n)?(l=x.BV.normalize(l),l=l>270?0:l>180?180:l,a.horizontalFieldOfView=2*l):a.verticalFieldOfView=l,s})),cancel:n}}),e)}_buildScaleOrientDragPipeline(e){let t=0,i=0;const s=(t,i)=>(s,r,n)=>{if(null==e)return{steps:r,cancel:n};const a=e.viewshed;return n=n.next((0,ie.di)(a,[t])),{steps:r=r.next(i(a,e)),cancel:n}};return(0,m.AL)([this._scaleOrientManipulation.createHeadingDragPipeline(s("heading",((t,s)=>s=>("start"===s.action&&(i=e.heading),t.heading=x.BV.normalize(i+s.deltaAngle),s))),e),this._scaleOrientManipulation.createTiltDragPipeline(s("tilt",((i,s)=>s=>{"start"===s.action&&(t=e.tilt);let r=t+s.deltaAngle;return r<-90?r=180:r>270&&(r=0),i.tilt=Ee.clamp(r),s})),e),this._scaleOrientManipulation.createDistanceDragPipeline(s("farDistance",((e,t)=>i=>{const s=(0,u.a)(Ue,i.renderEnd,t.observerRenderSpace),r=(0,u.G)(s)*t.metersPerUnit,n=(0,u.f)(s,t.targetDirection)<0?D.scaleOrientMinDistance:r;return e.farDistance=n,i})),e)])}_updateManipulatorVisibility(){const e=this._someManipulatorSelected(),t=null!=this._forceHoveringTask||this._someManipulatorHovering(),i=this._fieldOfViewManipulation.hovering,s=this.parentTool.creating;let r=[];const n=e=>{r.push(e.disableDisplay())};e||!s&&t?this.removeHandles(Pe):(this._scaleOrientManipulation.forEachManipulator(n),this._moveManipulation.forEachManipulator(n),this.addHandles(r,Pe),r=[]),e||!s&&t||s&&i?this.removeHandles(Re):(this._fieldOfViewManipulation.forEachManipulator(n),this.addHandles(r,Re)),e||!s?this.removeHandles(Ae):this.addHandles(this._observerManipulator.disableDisplay(),Ae)}_resetHoveringTask(){this._forceHoveringTask=(0,l.IM)(this._forceHoveringTask),this._updateManipulatorVisibility()}_forEachManipulator(e){this._forEachManipulation((t=>{t.forEachManipulator(e)})),e(this._observerManipulator)}_forEachManipulation(e){e(this._moveManipulation),e(this._fieldOfViewManipulation),e(this._scaleOrientManipulation)}get test(){return{moveManipulation:this._moveManipulation,fieldOfViewManipulation:this._fieldOfViewManipulation,scaleOrientManipulation:this._scaleOrientManipulation,viewshedComputedData:this.viewshedComputedData,setHoveringTimeoutPromise:e=>{this._forceHoveringTestPromise=e}}}};(0,s._)([(0,h.Cb)({constructOnly:!0})],xe.prototype,"analysis",void 0),(0,s._)([(0,h.Cb)({constructOnly:!0})],xe.prototype,"analysisViewData",void 0),(0,s._)([(0,h.Cb)({constructOnly:!0})],xe.prototype,"parentTool",void 0),(0,s._)([(0,h.Cb)({constructOnly:!0,nonNullable:!0})],xe.prototype,"view",void 0),(0,s._)([(0,h.Cb)()],xe.prototype,"viewshed",null),(0,s._)([(0,h.Cb)()],xe.prototype,"_grabbing",void 0),(0,s._)([(0,h.Cb)()],xe.prototype,"grabbing",null),(0,s._)([(0,h.Cb)()],xe.prototype,"viewshedComputedData",void 0),(0,s._)([(0,h.Cb)()],xe.prototype,"observer",null),xe=(0,s._)([(0,c.j)("esri.views.3d.analysis.Viewshed.ViewshedSubTool")],xe);const Ue=(0,p.Ue)(),Ee=new x.pE(0,180);var Fe=i(99047),Ie=i(97411),He=i(96026),ze=i(41781),Le=i(86509),ke=i(87888),je=i(81298),Ne=i(72612),Ze=i(848);const Be=Symbol("interactionVisuals");let Ge=class extends Le.f{constructor(e){super(e),this.removeIncompleteOnCancel=!1,this.automaticManipulatorSelection=!1,this._stagedViewshed=null,this._stagedViewshedComputedData=null,this._creationState=!1,this._interactionVisualElements=null,this._settings=new Fe.Z({getTheme:()=>this.view.effectiveTheme}),this._selectedManipulator=null}initialize(){this._intersector=(0,je.w)(this.view.state.viewingMode),this._createInteractionVisuals();const e=this.analysisViewData.viewshedComputedDataHandles;this.subToolHandles=(0,d.wZ)((()=>e),(e=>{let{viewshedComputedData:t}=e;const i=new xe({analysis:this.analysis,analysisViewData:this.analysisViewData,parentTool:this,view:this.view,viewshedComputedData:t});return{subTool:i,remove:()=>{this.selectedViewshed===t.viewshed&&(this.selectedViewshed=null),i.destroy()}}})),this.addHandles([(0,d.YP)((()=>null===e||void 0===e?void 0:e.some((e=>e.viewshedComputedData.isValid()))),(e=>{e&&this.finishToolCreation()}),d.tX),(0,d.YP)((()=>this._stagedViewshed),(e=>{var t;const i=this.analysisViewData.viewshedComputedDataHandles;this._stagedViewshedComputedData=null!=e&&null!=i?null===(t=this._findSubTool(e))||void 0===t?void 0:t.viewshedComputedData:null}),d.tX),(0,d.YP)((()=>this.firstGrabbedManipulator),(e=>{var t;if(null!=e){var i;const t=null===(i=this._findSubTool(e))||void 0===i?void 0:i.viewshed;this.selectedViewshed=t,this._selectManipulator(e)}else null===(t=this._selectedSubTool)||void 0===t||t.onManipulatorSelectionChanged()}),d.Z_),(0,d.YP)((()=>this.view.activeTool),(e=>{e!==this&&null!=e&&(this.selectedViewshed=null)})),(0,d.gx)((()=>{const e=this.selectedViewshedComputedData;return null==e?null:{subTool:this._selectedSubTool,observer:e.observerRenderSpace,target:e.targetRenderSpace}}),(e=>{const{subTool:t,observer:i,target:s}=e;null!==t&&void 0!==t&&t.moveInteractionState.dragging?this._updateInteractionVisualsLocation(i,!0):(null===t||void 0===t?void 0:t.scaleOrientInteractionState.dragging)&&this._updateInteractionVisualsLocation(s,!1)}),d.nn),(0,d.YP)((()=>this.creating),(()=>this.updateInteractionVisualsVisibility())),(0,d.YP)((()=>this.selectedViewshed),(e=>{const t=this._selectedManipulator,i=this._selectedSubTool;null==e?this._selectManipulator(null):null!=t&&i.hasManipulator(t)||this._selectManipulator(i.discManipulator)}),d.nn)])}destroy(){this.subToolHandles=(0,l.SC)(this.subToolHandles),this.removeHandles(Be)}onDeactivate(){this.removeStaged(),this._creationState=!1}get cursor(){return this.creating?"crosshair":null}get _selectedSubTool(){return this._findSubTool(this.selectedViewshed)}_selectManipulator(e){var t,i;const s=this._selectedManipulator;s!==e&&(this._selectedManipulator=e,null!=s&&(s.selected=!1),null!=e&&(e.selected=!0),null!==(t=this._findSubTool(s))&&void 0!==t&&t.onManipulatorSelectionChanged(),null===(i=this._selectedSubTool)||void 0===i||i.onManipulatorSelectionChanged())}get selectedViewshed(){return this.analysisViewData.selectedViewshed}set selectedViewshed(e){this.analysisViewData.selectedViewshed=e}get selectedViewshedComputedData(){var e;return null===(e=this._selectedSubTool)||void 0===e?void 0:e.viewshedComputedData}get stagedViewshed(){return this._stagedViewshed}get grabbing(){return this.subToolHandles.some((e=>{let{subTool:t}=e;return t.grabbing}))}get creating(){return this._creationState&&this.active}get isPlacingTarget(){return"placing-target"===this._creationState}createViewsheds(){this.selectedViewshed=null,this._creationState="placing-observer"}onManipulatorSelectionChanged(){this.subToolHandles.forEach((e=>e.subTool.onManipulatorSelectionChanged()))}onInputEvent(e){switch(e.type){case"immediate-double-click":this._doubleClickHandler(e);break;case"pointer-move":this._pointerMoveHandler(e);break;case"key-down":ke.Sn.cancel===e.key?this._cancelKeyHandler(e):ke.Sn.delete.includes(e.key)&&this._deleteKeyHandler();break;case"hold":this.updateInteractionVisualsVisibility(!0)}}onInputEventAfter(e){"immediate-click"===e.type&&this._clickPlacementHandler(e)}_clickPlacementHandler(e){if(!this.creating||this.hasFocusedManipulators)return;const t=this._intersectScreen(e,Je);if(null!=t){if("placing-observer"===this._creationState){var i;t.mapPoint.z=(null!==(i=t.mapPoint.z)&&void 0!==i?i:0)+1.5;const e=new O.Z({observer:t.mapPoint.clone(),feature:t.feature});this.analysis.viewsheds.add(e),this._stagedViewshed=e,this._creationState="placing-target",this._updateStagedViewshed(t.scenePoint)}else if("placing-target"===this._creationState){this._updateStagedViewshed(t.scenePoint);const e=this._stagedViewshed;this._creationState="placing-observer",this._stagedViewshed=null,this.selectedViewshed=e}e.stopPropagation()}}_doubleClickHandler(e){this.creating&&(this.removeStaged(),this._creationState=!1,this.view.activeTool=null,e.stopPropagation())}_pointerMoveHandler(e){if(!this.creating)return;const t=this._intersectScreen(e,Je);null!=t&&(this._updateInteractionVisualsLocation(t.scenePoint,!1),this._updateStagedViewshed(t.scenePoint))}_cancelKeyHandler(e){if(this.creating){if(this.removeStaged())return this._creationState="placing-observer",this.selectedViewshed=null,void e.stopPropagation();this._creationState=!1}else if(!this.grabbing)return this.selectedViewshed=null,void e.stopPropagation()}_deleteKeyHandler(){this.creating&&(this.removeStaged(),this._creationState="placing-observer"),null!=this.selectedViewshed&&this.analysis.viewsheds.remove(this.selectedViewshed)}_updateStagedViewshed(e){const t=this._stagedViewshed,i=this._stagedViewshedComputedData;if(null==t||null==i)return;const{heading:s,tilt:r,farDistance:n}=function(e,t,i){const s=t.observerRenderSpace,r=(0,u.a)(We,i,s),n=(0,u.G)(r)*t.metersPerUnit,a=e.renderCoordsHelper.basisMatrixAtPosition(s,Qe),o=(0,u.i)(Ye,a[8],a[9],a[10]),l=(0,P.Yq)(s,o,Ke),d=(0,P.nF)(l,i,qe),h=(0,u.a)(d,d,s),c=((0,u.G)(h)<1e-4?90:(0,b.BV)((0,u.r)(r,h)))*((0,u.f)(o,r)<0?-1:1)+90,p=(0,u.i)(Xe,a[4],a[5],a[6]),v=(0,b.BV)((0,u.r)(p,h)),f=(0,u.i)(Xe,a[0],a[1],a[2]);return{heading:(0,u.f)(h,f)<0?360-v:v,tilt:c,farDistance:n}}(this.view,i,e);t.farDistance=n,t.tilt=r,t.heading=s}removeStaged(){return null!=this._stagedViewshed&&(this.analysis.viewsheds.remove(this._stagedViewshed),this._stagedViewshed=null,!0)}_intersectScreen(e,t){const i=(0,Ne.Sj)(e);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(i,this._intersector);const s=this._intersector.results.min,r=t.scenePoint;if(!s.getIntersectionPoint(r))return null;const n=t.mapPoint;return n.spatialReference=this.view.spatialReference,this.view.renderCoordsHelper.fromRenderCoords(r,n),null==n?null:(t.feature=(0,ze.tB)(s,this.view),t)}_createInteractionVisuals(){this.removeHandles(Be);const e=this._settings.visualElements,t=new He.W({view:this.view,attached:!1,style:{glowWidth:e.heightPlane.glowWidth,innerWidth:e.heightPlane.innerWidth},isDecoration:!0}),i=new Ie.V({view:this.view,extensionType:e.zVerticalLine.extensionType,attached:!1,innerWidth:1,writeDepthEnabled:!1,renderOccluded:M.yD.OccludeAndTransparent,isDecoration:!0});this._interactionVisualElements={laserline:t,verticalLine:i},this.addHandles([(0,d.YP)((()=>e.zVerticalLine),(e=>e.apply(i)),d.tX),(0,d.YP)((()=>e.heightPlane),(e=>e.apply(t)),d.tX),(0,m.kB)((()=>{t.destroy(),i.destroy(),this._interactionVisualElements=null}))],Be)}updateInteractionVisualsVisibility(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const t=this.creating,i=this.analysisViewData.visible,s=this._selectedSubTool,r=this.selectedViewshedComputedData,n=(e,t)=>{const i=this._interactionVisualElements;null!=i&&(i.verticalLine.attached=t,i.laserline.attached=e)};if(t)return void n(i,!1);if(null==s||null==r)return void n(!1,!1);const a=s.moveInteractionState,o=e?a.grabbing:a.dragging,l=s.scaleOrientInteractionState,d=e?l.grabbing:l.dragging,h=i&&(o||d);if(n(h,o),h){const e=o?r.observerRenderSpace:r.targetRenderSpace;this._updateInteractionVisualsLocation(e,o)}}_updateInteractionVisualsLocation(e,t){const i=this._interactionVisualElements;if(null==i)return;const{laserline:s,verticalLine:r}=i;s.heightManifoldTarget=e,s.intersectsWorldUpAtLocation=t?e:null,null!=e&&r.setStartEndFromWorldDownAtLocation(e)}_findSubTool(e){var t;if(null==e)return null;const i=e instanceof X.Z?t=>t.subTool.hasManipulator(e):t=>t.subTool.viewshed===e;return null===(t=this.subToolHandles)||void 0===t||null===(t=t.find(i))||void 0===t?void 0:t.subTool}get test(){}};(0,s._)([(0,h.Cb)({constructOnly:!0})],Ge.prototype,"view",void 0),(0,s._)([(0,h.Cb)()],Ge.prototype,"analysisViewData",void 0),(0,s._)([(0,h.Cb)()],Ge.prototype,"removeIncompleteOnCancel",void 0),(0,s._)([(0,h.Cb)()],Ge.prototype,"automaticManipulatorSelection",void 0),(0,s._)([(0,h.Cb)({constructOnly:!0})],Ge.prototype,"analysis",void 0),(0,s._)([(0,h.Cb)()],Ge.prototype,"subToolHandles",void 0),(0,s._)([(0,h.Cb)()],Ge.prototype,"_stagedViewshed",void 0),(0,s._)([(0,h.Cb)()],Ge.prototype,"_stagedViewshedComputedData",void 0),(0,s._)([(0,h.Cb)()],Ge.prototype,"_creationState",void 0),(0,s._)([(0,h.Cb)({readOnly:!0})],Ge.prototype,"cursor",null),(0,s._)([(0,h.Cb)()],Ge.prototype,"_selectedManipulator",void 0),(0,s._)([(0,h.Cb)()],Ge.prototype,"_selectedSubTool",null),(0,s._)([(0,h.Cb)()],Ge.prototype,"selectedViewshed",null),(0,s._)([(0,h.Cb)()],Ge.prototype,"selectedViewshedComputedData",null),(0,s._)([(0,h.Cb)()],Ge.prototype,"stagedViewshed",null),(0,s._)([(0,h.Cb)()],Ge.prototype,"grabbing",null),(0,s._)([(0,h.Cb)()],Ge.prototype,"creating",null),(0,s._)([(0,h.Cb)()],Ge.prototype,"isPlacingTarget",null),Ge=(0,s._)([(0,c.j)("esri.views.3d.analysis.Viewshed.ViewshedTool")],Ge);const We=(0,p.Ue)(),Ye=(0,p.Ue)(),qe=(0,p.Ue)(),Xe=(0,p.Ue)(),Qe=(0,y.Ue)(),Ke=(0,P.Ue)(),Je={mapPoint:new Ze.Z,scenePoint:(0,p.Ue)(),feature:null},$e=Ge;var et=i(33837),tt=i(66730),it=i(52168),st=i(91526),rt=i(2952),nt=i(4760);class at extends it._{constructor(e){super(e),this._material=null,this._viewshedComputedData=null,this._material=new pe.E({...T.shapeMaterialParameters,isDecoration:this.isDecoration,writeDepth:!1}),this.applyProperties(e)}get viewshedComputedData(){return this._viewshedComputedData}set viewshedComputedData(e){this._viewshedComputedData=e,this.updateTransform()}updateTransform(){const e=this._viewshedComputedData;if(null==e)return;const t=(0,y.Ue)(),i=e.farDistanceRenderSpace;(0,V.xJ)(t,(0,p.al)(i,i,i)),j(e,ut),(0,V.dC)(t,ut,t),(0,V.vc)(ut,this._viewshedComputedData.observerRenderSpace),(0,V.dC)(t,ut,t),this.transform=t}createExternalResources(){}destroyExternalResources(){}forEachExternalMaterial(e){null!=this._material&&e(this._material)}createGeometries(e){const{_material:t,viewshedComputedData:i}=this;null!=i&&null!=t&&i.isValid()&&function(e,t){const{horizontalFieldOfView:i,verticalFieldOfView:s}=t,r=(0,u.i)(lt,0,0,1),n=(0,u.i)(dt,0,1,0),a=(0,u.i)(ht,1,0,0);Z(r,r,(0,b.Vl)(s/2),n),Z(r,r,(0,b.Vl)(i/2),a);const o=e=>Math.ceil(Math.abs(e)/S)+1,l=(0,b.Vl)(i),d=(0,u.c)(ct,a),h=o(l),c=ot(-l/(h-1)),p=(0,V.Us)(ut,c,d),v=(0,b.Vl)(-s),f=o(v),w=ot(v/(f-1)),m=(0,u.c)(dt,n),_=(0,V.Us)(pt,(0,b.Vl)(i)/2,a);(0,u.t)(m,m,_);const g=pt,y=[],C=(0,u.c)(ht,r);for(let b=0;b<h;b++){(0,V.Us)(g,w,m);for(let e=0;e<f;e++){const t=3*(e*h+b);y[t]=C[0],y[t+1]=C[1],y[t+2]=C[2],(0,u.t)(C,C,g)}(0,u.t)(m,m,p),(0,u.t)(r,r,p),(0,u.c)(C,r)}const M=h*f;y[3*M]=0,y[3*M+1]=0,y[3*M+2]=0;const D=[];for(let u=0;u<h-1;u++)for(let e=0;e<f-1;e++){const t=6*(e*(h-1)+u);D[t]=e*h+u,D[t+1]=(e+1)*h+u,D[t+2]=e*h+u+1,D[t+3]=e*h+u+1,D[t+4]=(e+1)*h+u,D[t+5]=(e+1)*h+u+1}const T=[D];if(360!==i&&0!==s){const e=[],t=[];for(let i=0;i<f-1;i++){const s=3*i;e[s]=M,e[s+1]=(i+1)*h,e[s+2]=i*h,t[s]=M,t[s+1]=i*h+h-1,t[s+2]=(i+1)*h+h-1}T.push(e,t)}if(180!==s&&0!==i){const e=[],t=[];for(let i=0;i<h-1;i++){const s=3*i;e[s]=M,e[s+1]=i,e[s+2]=i+1,t[s]=M,t[s+1]=i+(f-1)*h+1,t[s+2]=i+(f-1)*h}T.push(e,t)}return T.map((t=>{const i=[[nt.T.POSITION,new st.a(y,t,3,!0)]];return new rt.Z(e,i)}))}(t,i).forEach((t=>e.addGeometry(t)))}}function ot(e){return isNaN(e)?1:e}const lt=(0,p.Ue)(),dt=(0,p.Ue)(),ht=(0,p.Ue)(),ct=(0,p.Ue)(),ut=(0,y.Ue)(),pt=(0,y.Ue)();var vt=i(86700);let ft=class extends n.Z{constructor(e){super(e),this.visible=!0,this._viewshedCorners={topLeft:(0,p.Ue)(),topRight:(0,p.Ue)(),bottomLeft:(0,p.Ue)(),bottomRight:(0,p.Ue)()},this._arcCenterPoints={top:(0,p.Ue)(),bottom:(0,p.Ue)(),left:(0,p.Ue)(),right:(0,p.Ue)()},this._parallelCenters={top:(0,p.Ue)(),bottom:(0,p.Ue)()}}initialize(){const e={view:this.view,isDecoration:!0},t={...e,color:this._color,renderOccluded:M.yD.OccludeAndTransparent},i={...t,stipplePattern:(0,vt.z5)(2)};this._observerVisualElement=new tt.L({...e,...T.observerPointConfiguration}),this._shapeVisualElement=new at(e),this._frameLinesVisualElement=new et.r(t),this._leftArcVisualElement=new et.r(t),this._rightArcVisualElement=new et.r(t),this._topArcVisualElement=new et.r(t),this._bottomArcVisualElement=new et.r(t),this._centralLongitude=new et.r(i),this._centralLatitude=new et.r(i),this.addHandles([(0,d.YP)((()=>{const e=this.viewshedComputedData;if(null===e||void 0===e||!e.isValid())return null;const t=this._viewshedCorners,i=this._arcCenterPoints,s=this._parallelCenters;return e.cornerPoints(t),e.arcCentersPoints(i),e.parallelCenterPoints(s),{viewshedComputedData:e,corners:t,arcCenters:i,parallelCenters:s,interactive:this.analysisViewData.interactive,selected:this._selected}}),(e=>{const t=null!=e;this._forEachVisualElement((e=>e.attached=t)),t&&this._updateVisualElements(e)}),{initial:!0,equals:g.fS}),(0,d.YP)((()=>{const{viewshedComputedData:e}=this,{horizontalFieldOfView:t,verticalFieldOfView:i}=null!==e&&void 0!==e?e:{};return{viewshedComputedData:e,horizontalFieldOfView:t,verticalFieldOfView:i}}),(e=>{let{viewshedComputedData:t}=e;const{_shapeVisualElement:i}=this;t!==i.viewshedComputedData&&(i.viewshedComputedData=t),this._shapeVisualElement.recreateGeometry()}),d.nn),(0,d.YP)((()=>{var e;const{interactive:t}=this.analysisViewData;return{visible:this.visible,selected:t&&this._selected,staged:t&&this._staged,horFovNot360:360!==(null===(e=this.viewshedComputedData)||void 0===e?void 0:e.horizontalFieldOfView)}}),(e=>{let{visible:t,selected:i,staged:s,horFovNot360:r}=e;const n=i||s;this._shapeVisualElement.visible=t,this._topArcVisualElement.visible=t,this._bottomArcVisualElement.visible=t,this._frameLinesVisualElement.visible=t&&r;const a=t&&(i||r);this._leftArcVisualElement.visible=a,this._rightArcVisualElement.visible=a,this._forEachLineVisualElement((e=>{e.width=n?T.frameWidthSelected:T.frameWidthNotSelected,e.renderOccluded=i?M.yD.OccludeAndTransparent:M.yD.Occlude})),[this._centralLatitude,this._centralLongitude].forEach((e=>{e.width=2*(n?T.frameWidthSelected:T.frameWidthNotSelected),e.visible=t&&i}))}),d.nn),(0,d.YP)((()=>{var e;const{analysisViewData:{interactive:t,tool:i},_selected:s,visible:r}=this,n=this.view.activeTool,a=!(null!==i&&void 0!==i&&i.active)&&n instanceof $e&&n.creating;return{observerVisible:r&&!s&&(!t||null!==(e=null===i||void 0===i?void 0:i.creating)&&void 0!==e&&e||a),color:this._color}}),(e=>{let{observerVisible:t,color:i}=e;this._observerVisualElement.visible=t,this._forEachLineVisualElement((e=>e.color=i))}),d.nn)])}get _color(){var e,t;const{viewshedComputedData:i,_selected:s,analysisViewData:r}=this;if(null==i)return _.Z.toUnitRGBA(T.frameColor);const n=(null===(e=r.tool)||void 0===e?void 0:e.active)||r.interactive,a=i.viewshed===(null===(t=r.tool)||void 0===t?void 0:t.stagedViewshed),o=n&&(s||a)?this.view.effectiveTheme.accentColor:T.frameColor;return _.Z.toUnitRGBA(o)}get _selected(){const{viewshedComputedData:e,analysisViewData:{selectedViewshedComputedData:t}}=this;return null!=e&&e===t}get _staged(){const{analysisViewData:{tool:e},viewshedComputedData:t}=this;return null!=e&&e.creating&&e.stagedViewshed===(null===t||void 0===t?void 0:t.viewshed)}destroy(){this._observerVisualElement=(0,l.SC)(this._observerVisualElement),this._shapeVisualElement=(0,l.SC)(this._shapeVisualElement),this._frameLinesVisualElement=(0,l.SC)(this._frameLinesVisualElement),this._leftArcVisualElement=(0,l.SC)(this._leftArcVisualElement),this._rightArcVisualElement=(0,l.SC)(this._rightArcVisualElement),this._topArcVisualElement=(0,l.SC)(this._topArcVisualElement),this._bottomArcVisualElement=(0,l.SC)(this._bottomArcVisualElement),this._centralLongitude=(0,l.SC)(this._centralLongitude),this._centralLatitude=(0,l.SC)(this._centralLatitude)}_forEachLineVisualElement(e){[this._frameLinesVisualElement,this._leftArcVisualElement,this._rightArcVisualElement,this._topArcVisualElement,this._bottomArcVisualElement,this._centralLatitude,this._centralLongitude].forEach(e)}_forEachVisualElement(e){this._forEachLineVisualElement(e),e(this._observerVisualElement),e(this._shapeVisualElement)}_updateVisualElements(e){const{viewshedComputedData:t,corners:i,arcCenters:s,parallelCenters:r}=e,n=(0,p.d9)(t.observerRenderSpace);this._observerVisualElement.geometry=t.observer,this._shapeVisualElement.updateTransform(),this._updateFrameLines(n,i),this._updateFrameArcs(t,i,r),this._updateCentralHelperArcs(t,s)}_updateFrameLines(e,t){this._frameLinesVisualElement.geometry=[[e,t.topLeft],[e,t.topRight],[e,t.bottomLeft],[e,t.bottomRight]]}_updateFrameArcs(e,t,i){const{observerRenderSpace:s,rightVector:r,horizontalFieldOfView:n,tiltedUpVector:a}=e,o=(0,b.Vl)(n),l=(0,p.Ue)(),d=(0,y.Ue)();(0,V.Us)(d,o/2,a),(0,u.t)(l,r,d),wt(this._leftArcVisualElement,s,t.bottomLeft,t.topLeft,"forward",l),(0,V.Us)(d,-o/2,a),(0,u.i)(l,0,0,0),(0,u.t)(l,r,d),wt(this._rightArcVisualElement,s,t.bottomRight,t.topRight,"forward",l);const h=n>180?"backward":"forward";wt(this._topArcVisualElement,i.top,t.topRight,t.topLeft,h,a),wt(this._bottomArcVisualElement,i.bottom,t.bottomRight,t.bottomLeft,h,a)}_updateCentralHelperArcs(e,t){const i=e.observerRenderSpace,s=e.horizontalFieldOfView>=180?"backward":"forward";wt(this._centralLatitude,i,t.right,t.left,s,e.tiltedUpVector),wt(this._centralLongitude,i,t.top,t.bottom,"forward",e.leftVector)}get test(){}};function wt(e,t,i,s,r,n){let a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:S;const o=(0,p.Ue)();(0,u.a)(o,i,t);const l=(0,u.G)(o),d=(0,p.Ue)();(0,u.a)(d,s,t),(0,u.n)(d,d),(0,u.h)(d,d,l);let h=(0,u.r)(o,d);const c=(0,p.d9)(n);"backward"===r&&((0,u.v)(c,c),h=-(2*Math.PI-h));const v=[],f=Math.ceil(Math.abs(h)/a),w=(0,y.Ue)();(0,V.Us)(w,h/f,c);const m=(0,p.Ue)();(0,u.c)(m,o);const _=(0,p.Ue)();(0,u.c)(_,i);for(let g=0;g<f;g++){const e=(0,p.Ue)();(0,u.c)(e,_),(0,u.t)(m,m,w),(0,u.g)(_,t,m);const i=(0,p.Ue)();(0,u.c)(i,_),v.push([e,i])}e.geometry=v}(0,s._)([(0,h.Cb)()],ft.prototype,"view",void 0),(0,s._)([(0,h.Cb)()],ft.prototype,"analysisViewData",void 0),(0,s._)([(0,h.Cb)()],ft.prototype,"viewshedComputedData",void 0),(0,s._)([(0,h.Cb)()],ft.prototype,"visible",void 0),(0,s._)([(0,h.Cb)()],ft.prototype,"_color",null),(0,s._)([(0,h.Cb)()],ft.prototype,"_selected",null),(0,s._)([(0,h.Cb)()],ft.prototype,"_staged",null),ft=(0,s._)([(0,c.j)("esri.views.3d.analysis.Viewshed.ViewshedVisualization")],ft);const mt=ft;let _t=class extends n.Z{get visible(){return this.analysisViewData.visible}constructor(e){super(e)}initialize(){const e=this.analysisViewData,t=(0,d.wZ)((()=>this.analysisViewData.viewshedComputedDataHandles),(t=>{let{viewshedComputedData:i}=t;const s=new mt({view:this.view,viewshedComputedData:i,analysisViewData:e});return{visualization:s,remove:()=>s.destroy()}}));this._viewshedVisualizations=t,this.addHandles([(0,m.ed)(t),(0,d.YP)((()=>this.visible),(e=>this._viewshedVisualizations.forEach((t=>{let{visualization:i}=t;return i.visible=e}))),d.nn)])}get test(){}};var gt;(0,s._)([(0,h.Cb)({constructOnly:!0})],_t.prototype,"analysisViewData",void 0),(0,s._)([(0,h.Cb)({constructOnly:!0,nonNullable:!0})],_t.prototype,"view",void 0),(0,s._)([(0,h.Cb)({constructOnly:!0})],_t.prototype,"isDecoration",void 0),(0,s._)([(0,h.Cb)()],_t.prototype,"visible",null),_t=(0,s._)([(0,c.j)("esri.views.3d.analysis.Viewshed.ViewshedAnalysisVisualization")],_t);let bt=gt=class extends n.Z{constructor(e){super(e),this.observerRenderSpaceOverride=null}get observer(){var e;return null!==(e=this.viewshed.observer)&&void 0!==e?e:new Ze.Z}get effectiveObserverRenderSpace(){var e;return null!==(e=this.observerRenderSpaceOverride)&&void 0!==e?e:this.observerRenderSpace}get effectiveObserver(){return this.renderSpaceToPoint(this.effectiveObserverRenderSpace,this.observer.spatialReference)}get effectiveTargetRenderSpace(){return this._computeTargetRenderSpace(this.effectiveObserverRenderSpace)}get farDistance(){return this.viewshed.farDistance}get farDistanceRenderSpace(){return this.farDistance/this.metersPerUnit}get heading(){return this.viewshed.heading}get tilt(){return this.viewshed.tilt}get feature(){return this.viewshed.feature}get tiltParallelToSurface(){return this.tilt-90}get horizontalFieldOfView(){return this.viewshed.horizontalFieldOfView}get verticalFieldOfView(){return this.viewshed.verticalFieldOfView}get observerRenderSpace(){return this._pointToRenderSpace(this.observer,(0,p.Ue)())}get target(){const e=this.targetRenderSpace;return this.renderSpaceToPoint(e,this.observer.spatialReference)}get targetRenderSpace(){return this._computeTargetRenderSpace(this.observerRenderSpace)}get targetDirection(){const e=(0,u.a)((0,p.Ue)(),this.targetRenderSpace,this.observerRenderSpace);return(0,u.n)(e,e)}get tiltedUpVector(){const e=Z((0,p.Ue)(),this.upVector,-(0,b.Vl)(this.tiltParallelToSurface),this.leftVector);return(0,u.n)(e,e)}get _basis(){return this.renderCoordsHelper.basisMatrixAtPosition(this.observerRenderSpace,(0,y.Ue)())}get upVector(){const e=this._basis;return(0,p.al)(e[8],e[9],e[10])}get northVector(){const e=this._basis;return(0,p.al)(e[4],e[5],e[6])}get leftVector(){const e=this.upVector,t=Z((0,p.Ue)(),this.northVector,-(0,b.Vl)(this.heading),e);return(0,u.e)(t,e,t)}get rightVector(){return(0,u.v)((0,p.Ue)(),this.leftVector)}clone(){return new gt({renderCoordsHelper:this.renderCoordsHelper,viewshed:this.viewshed.clone()})}isValid(){return this.viewshed.isValid()}get metersPerUnit(){return this.renderCoordsHelper.spatialReference.metersPerUnit}pointOnSphere(e,t,i){const{observerRenderSpace:s,targetRenderSpace:r}=this,n=(0,u.a)(Vt,r,s);return Z(n,n,-(0,b.Vl)(t),this.leftVector),Z(n,n,-(0,b.Vl)(e),this.tiltedUpVector),(0,u.g)(i,n,s)}cornerPoints(e){const t=this.horizontalFieldOfView/2,i=this.verticalFieldOfView/2;this.pointOnSphere(-t,i,e.topLeft),this.pointOnSphere(t,i,e.topRight),this.pointOnSphere(-t,-i,e.bottomLeft),this.pointOnSphere(t,-i,e.bottomRight)}arcCentersPoints(e){const t=this.horizontalFieldOfView/2,i=this.verticalFieldOfView/2;this.pointOnSphere(0,i,e.top),this.pointOnSphere(0,-i,e.bottom),this.pointOnSphere(-t,0,e.left),this.pointOnSphere(t,0,e.right)}parallelCenterPoints(e){const t=this.observerRenderSpace,i=this.farDistanceRenderSpace*Math.sin((0,b.Vl)(this.verticalFieldOfView/2)),s=(0,u.h)(Vt,this.tiltedUpVector,i);(0,u.g)(e.top,t,s),(0,u.a)(e.bottom,t,s)}renderSpaceToPoint(e,t){const i=Vt;return this.renderCoordsHelper.fromRenderCoords(e,i,t),new Ze.Z(i[0],i[1],i[2],t)}_pointToRenderSpace(e,t){const i=(0,p.nI)(e.toArray());return this.renderCoordsHelper.toRenderCoords(i,e.spatialReference,t),t}_computeTargetRenderSpace(e){const{leftVector:t,northVector:i,upVector:s}=this,r=this.farDistanceRenderSpace,n=(0,p.Ue)();return(0,u.h)(n,i,r),Z(n,n,-(0,b.Vl)(this.heading),s),Z(n,n,-(0,b.Vl)(this.tiltParallelToSurface),t),(0,u.g)(n,e,n),n}};(0,s._)([(0,h.Cb)()],bt.prototype,"renderCoordsHelper",void 0),(0,s._)([(0,h.Cb)()],bt.prototype,"viewshed",void 0),(0,s._)([(0,h.Cb)()],bt.prototype,"observerRenderSpaceOverride",void 0),(0,s._)([(0,h.Cb)()],bt.prototype,"observer",null),(0,s._)([(0,h.Cb)()],bt.prototype,"effectiveObserverRenderSpace",null),(0,s._)([(0,h.Cb)()],bt.prototype,"effectiveObserver",null),(0,s._)([(0,h.Cb)()],bt.prototype,"effectiveTargetRenderSpace",null),(0,s._)([(0,h.Cb)()],bt.prototype,"farDistance",null),(0,s._)([(0,h.Cb)()],bt.prototype,"farDistanceRenderSpace",null),(0,s._)([(0,h.Cb)()],bt.prototype,"heading",null),(0,s._)([(0,h.Cb)()],bt.prototype,"tilt",null),(0,s._)([(0,h.Cb)()],bt.prototype,"feature",null),(0,s._)([(0,h.Cb)()],bt.prototype,"tiltParallelToSurface",null),(0,s._)([(0,h.Cb)()],bt.prototype,"horizontalFieldOfView",null),(0,s._)([(0,h.Cb)()],bt.prototype,"verticalFieldOfView",null),(0,s._)([(0,h.Cb)()],bt.prototype,"observerRenderSpace",null),(0,s._)([(0,h.Cb)()],bt.prototype,"target",null),(0,s._)([(0,h.Cb)()],bt.prototype,"targetRenderSpace",null),(0,s._)([(0,h.Cb)()],bt.prototype,"targetDirection",null),(0,s._)([(0,h.Cb)()],bt.prototype,"tiltedUpVector",null),(0,s._)([(0,h.Cb)()],bt.prototype,"_basis",null),(0,s._)([(0,h.Cb)()],bt.prototype,"upVector",null),(0,s._)([(0,h.Cb)()],bt.prototype,"northVector",null),(0,s._)([(0,h.Cb)()],bt.prototype,"leftVector",null),(0,s._)([(0,h.Cb)()],bt.prototype,"rightVector",null),(0,s._)([(0,h.Cb)()],bt.prototype,"isValid",null),(0,s._)([(0,h.Cb)()],bt.prototype,"metersPerUnit",null),bt=gt=(0,s._)([(0,c.j)("esri.views.3d.analysis.Viewshed.ViewshedComputedData")],bt);const Vt=(0,p.Ue)();var yt=i(88153),Ct=i(54463),Mt=i(80987),St=i(83479),Dt=i(85192),Tt=i(31239),Ot=i(2263),Pt=i(18020),Rt=i(32251),At=i(86361),xt=i(81296);let Ut=class extends xt.Z{constructor(){super(...arguments),this.sectionAngles=(0,At.Ue)()}get sectionAnglesDeg(){return(0,At.nI)(this.sectionAngles.map((e=>(0,b.BV)(e))))}set sectionAnglesDeg(e){this.sectionAngles=(0,At.nI)(e.map((e=>(0,b.Vl)(e))))}get projectionMatrix(){return(0,V.dC)((0,y.Ue)(),this.sectionMatrix,this._projectionMatrixInternal)}get sectionMatrix(){const e=this.sectionAngles[0],t=this.sectionAngles[1],i=this.sectionAngles[2],s=this.sectionAngles[3];(0,ee.hu)(e<=t),(0,ee.hu)(i<=s);const r=2*Math.tan(this.fovX/2),n=2*Math.tan(this.fovY/2),a=Math.tan(e),o=Math.tan(t),l=Math.tan(i),d=o-a,h=Math.tan(s)-l,c=r/d,u=n/h,p=-(a+d/2)/r*2,v=-(l+h/2)/n*2,f=(0,y.Ue)();(0,V.vc)(f,[p,v,0]);const w=(0,y.Ue)();(0,V.xJ)(w,[c,u,1]);const m=(0,y.Ue)();return(0,V.dC)(m,w,f)}get _sectionRatioX(){const e=Math.tan(this.sectionAngles[0]),t=Math.tan(this.sectionAngles[1]),i=2*Math.tan(this.fovX/2);return Math.min(1,(t-e)/i)}setViewport(e,t){const i=t*this._sectionRatioX;return this.viewport=[e[0],e[1],i,t],i}};(0,s._)([(0,h.Cb)()],Ut.prototype,"sectionAngles",void 0),(0,s._)([(0,h.Cb)()],Ut.prototype,"sectionAnglesDeg",null),(0,s._)([(0,h.Cb)()],Ut.prototype,"projectionMatrix",null),(0,s._)([(0,h.Cb)()],Ut.prototype,"sectionMatrix",null),(0,s._)([(0,h.Cb)()],Ut.prototype,"_sectionRatioX",null),Ut=(0,s._)([(0,c.j)("esri.views.3d.webgl-engine.lib.ViewshedFaceCamera")],Ut);var Et=i(8548);class Ft{constructor(){this.textureSizeQuality=1,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.textureSizeMultiple=128,this.toleranceSides=5,this.toleranceBottomTop=10}textureSizeModifier(e){const t=e?this.textureSizeModHighQuality:this.textureSizeModLowQuality;return this.textureSizeQuality*t}textureResizeModulo(e){return Math.ceil(e/this.textureSizeMultiple)*this.textureSizeMultiple}}const It=["front","left","right","back","top","bottom"];class Ht{constructor(e){this._fbos=e,this._minTextureSize=16,this._faces={},this._width=0,this._height=0,this.settings=new Ft,this._maxTextureSize=Math.min((0,a.Z)("esri-mobile")?4096:16384,e.rctx.parameters.maxTextureSize)}get depthTexture(){var e;return null===(e=this._handle)||void 0===e?void 0:e.getTexture()}get ready(){return null!=this.depthTexture&&0!==this._width&&0!==this._height}get nearFar(){const e=this.faces;return 0===e.length?null:e[0].nearFar}get numActiveFaces(){const e=this._faces;let t=0;return Object.keys(e).forEach((i=>{e[i]&&(t+=1)})),t}get faces(){const e=this._faces,t=[];for(const i of It){const s=e[i];s&&t.push(s)}return t}get atlasRegions(){return this.faces.map((e=>[e.x/this._width,(e.x+e.width)/this._width,e.y/this._height,(e.y+e.height)/this._height]))}get viewshedProjectionMatrices(){return this.faces.map((e=>e.projectionMatrix))}get viewshedViewMatrices(){return this.faces.map((e=>e.viewMatrix))}_setupFaceCamera(e,t,i,s){const{effectiveObserverRenderSpace:r,tiltedUpVector:n,targetRenderSpace:a,farDistanceRenderSpace:o,horizontalFieldOfView:l,verticalFieldOfView:d}=t,h=(0,p.Ue)();(0,u.a)(h,a,r);const c=(0,p.Ue)(),v=(0,p.Ue)(),f=(e,t)=>{const i=(0,p.Ue)(),s=(0,y.Ue)();return(0,V.Us)(s,e,t),(0,u.t)(i,h,s),(0,u.g)(i,r,i),i};let w,m=n;const _=Math.min(90,l),g=Math.min(90,Math.max(0,(l-90)/2));let C=-45,M=45,S=-45,D=45;if(function(e){return!["top","bottom"].includes(e)}(e)){const e=e=>(0,b.uZ)(e,-45,45);S=e(-d/2)-this.settings.toleranceBottomTop,D=e(+d/2)+this.settings.toleranceBottomTop}switch(e){case"front":w=a,C=-_/2,M=_/2;break;case"left":w=f(Math.PI/2,n),C=45-g;break;case"right":w=f(-Math.PI/2,n),M=-45+g;break;case"top":w=(0,u.g)(c,r,n),m=(0,u.v)(v,h);break;case"bottom":w=(0,u.a)(c,r,n),m=h;break;case"back":w=f(Math.PI,n)}const T=new Ut({center:w,eye:r,up:m,far:o});T.sectionAnglesDeg=[C-this.settings.toleranceSides,M+this.settings.toleranceSides,S,D],T.fovY=Math.PI/2;const O=T.setViewport(i,s);return this._faces[e]=T,O}isActive(e){return this._computeActiveFaces(e).size>0}_computeActiveFaces(e){const t=new Set,{horizontalFieldOfView:i,verticalFieldOfView:s}=e,r=-s/2,n=s/2;return 0===i||0===s||(r<=45&&n>=-45&&t.add("front"),i>90&&(t.add("left"),t.add("right")),i>270&&t.add("back"),n>45-this.settings.toleranceBottomTop&&t.add("top"),r<-45+this.settings.toleranceBottomTop&&t.add("bottom")),t}_computeBaseTextureSize(e,t,i,s){const r=t/e.pixelRatio,n=this.settings.textureSizeModifier(i),a=Math.max(e.fullWidth,e.fullHeight),o=(0,Rt.nq)(Math.floor(a*r*n)),l=Math.floor(this._maxTextureSize/s),d=(0,b.uZ)(o,this._minTextureSize,l);return(0,Rt.pf)(d)}_ensureFBO(e){var t,i,s;const r=this._width,n=this._height;(null===(t=this._handle)||void 0===t||null===(t=t.fbo)||void 0===t?void 0:t.width)===r&&(null===(i=this._handle)||void 0===i||null===(i=i.fbo)||void 0===i?void 0:i.height)===n||(null!==(s=this._handle)&&void 0!==s&&s.release(),this._handle=this._fbos.acquire(r,n,"viewshed shadow map",Pt.q.RGBA4));const a=e?Pt.m.DEPTH_STENCIL_TEXTURE:Pt.m.DEPTH16_BUFFER;this._handle.acquireDepth(a)}clearFBO(e){var t;const i=this._fbos.rctx;this._ensureFBO(e),i.bindFramebuffer(null===(t=this._handle)||void 0===t?void 0:t.fbo),i.setClearColor(1,1,1,1),i.clear(Et.Hf.COLOR|Et.Hf.DEPTH)}dispose(){this._handle=(0,l.RY)(this._handle)}start(e,t,i,s){let r=arguments.length>4&&void 0!==arguments[4]&&arguments[4];this._faces={};const n=this._computeActiveFaces(t),a=n.size;if(0===a)return!1;const o=this._computeBaseTextureSize(e,s,i,a);let l=0,d=0,h=0;return It.filter((e=>n.has(e))).forEach((e=>{const i=function(e,t){if(t<4)return 0;const i="front"===e||"left"===e;return 4===t?i?0:1:i||"right"===e?0:1}(e,a);i>d&&(h=Math.max(h,l),l=0),d=i;const s=i*o;l+=this._setupFaceCamera(e,t,[l,s],o)})),h=Math.max(h,l),this._width=this.settings.textureResizeModulo(h),this._height=function(e){return e<4?1:2}(a)*o,this.clearFBO(r),!0}finish(){var e;null===(e=this._handle)||void 0===e||e.detachDepth()}get test(){return{faces:this._faces,faceTypes:It,width:this._width,height:this._height,getFBO:()=>this._fbos.acquire(this._width,this._height,"viewshed shadow map",Pt.q.RGBA4)}}}var zt=i(95720),Lt=i(82144),kt=i(78914),jt=i(36207);class Nt extends kt.A{constructor(e,t,s){super(e,t,new Lt.J(zt.a,(()=>i.e(191).then(i.bind(i,20191)))),s)}initializePipeline(){return(0,jt.sm)({colorWrite:jt.gf,blending:jt.Dh})}}let Zt=class extends Tt.Z{get shadowMap(){return this._shadowMap}get hasViewsheds(){return this._viewsheds.length>0}get _contentPixelRatio(){return this.view.state.contentPixelRatio}get _viewshedsInView(){return this._viewsheds.items.filter((e=>function(e,t){const i=(0,St.l)(t.observerRenderSpace,t.farDistanceRenderSpace);return!!e.ready&&e.frustum.intersectsSphere(i)}(this.view,e)))}constructor(e){super(e),this._techniques=null,this._passParameters=new zt.V,this._viewsheds=new Mt.Z,this._shadowMap=null,this.consumes={required:[Dt.CM.VIEWSHED],optional:["normals"]},this.produces=Dt.CM.VIEWSHED,this.requireGeometryDepth=!0}initialize(){this._shadowMap=new Ht(this.fboCache),this.addHandles([(0,d.YP)((()=>this.view.resolutionScale),(e=>{const t=this._shadowMap;t&&(t.settings.textureSizeQuality=e)}),d.nn),(0,d.gx)((()=>!this.hasViewsheds),(()=>{var e;return null===(e=this._shadowMap)||void 0===e?void 0:e.dispose()})),(0,d.gx)((()=>this.view._stage.renderView.techniques),(e=>this._techniques=e),d.nn),(0,d.YP)((()=>this._viewshedsInView.map((e=>[e.observerRenderSpace,e.heading,e.tilt,e.farDistance,e.horizontalFieldOfView,e.verticalFieldOfView]))),(()=>this.requestRender(C.Xx.UPDATE)),d.Z_)])}destroy(){this._shadowMap=(0,l.M2)(this._shadowMap)}precompile(){if(this.hasViewsheds){var e;null===(e=this._techniques)||void 0===e||e.precompile(Nt);for(const e of this._viewshedsInView){var t;if(null!==(t=this._shadowMap)&&void 0!==t&&t.isActive(e))return void this.view._stage.renderer.precompileViewshedShadowMap()}}}render(e){var t,i,s,r;const n=this.bindParameters,a=this.renderingContext,o=e.find((e=>{let{name:t}=e;return t===Dt.CM.VIEWSHED}));if(!this.hasViewsheds||!n.depth)return o;this._passParameters.shadowMap=null!==(t=this._shadowMap)&&void 0!==t?t:this._passParameters.shadowMap,this._passParameters.normals=null===(i=e.find((e=>{let{name:t}=e;return"normals"===t})))||void 0===i?void 0:i.getTexture();const l=null===(s=this._techniques)||void 0===s?void 0:s.acquire(Nt);if(null===l||void 0===l||!l.compiled)return this.requestRender(C.Xx.UPDATE),null!==l&&void 0!==l&&l.release(),o;const d=this.view._stage.renderer.isFeatureEnabled(Ot.Y.HighResolutionViewshed);for(const c of this._viewshedsInView){var h;if(!this._renderShadowCubeMap(n,c,d)||null===(h=this._shadowMap)||void 0===h||!h.ready)continue;const e=this._setupViewshedParameters(c,n.camera);a.bindTechnique(l,n,e),a.bindFramebuffer(o.fbo),a.screen.draw()}return l.release(),null!==(r=this.shadowMap)&&void 0!==r&&r.dispose(),o}updateViewsheds(e){const t=this._viewsheds,{removes:i,adds:s}=e;if(i&&(Array.isArray(i)?t.removeMany(i):t.remove(i)),s)if(Array.isArray(s)){const e=s.filter((e=>!t.includes(e)));t.addMany(e)}else t.includes(s)||t.add(s)}_renderShadowCubeMap(e,t,i){const s=this._shadowMap;if(!s)return!1;const r=this.view.basemapTerrain.hasStencilEnabledExtents,n=s.start(e.camera,t,i,this._contentPixelRatio,r);return n&&s.faces.forEach((e=>this.view._stage.renderer.renderViewshedShadowMap(e))),s.finish(),n}_setupViewshedParameters(e,t){var i;const s=this._shadowMap;if(!s)return this._passParameters;const r=this._passParameters,n=e.effectiveObserverRenderSpace;r.localOrigin=n,r.observerOffset=(0,u.a)(Gt,e.observerRenderSpace,e.effectiveObserverRenderSpace),r.fovs=[(0,b.Vl)(e.horizontalFieldOfView),(0,b.Vl)(e.verticalFieldOfView)],r.headingAndTilt=[(0,b.Vl)(e.heading),(0,b.Vl)(e.tiltParallelToSurface)],r.upVector=e.tiltedUpVector;const a=function(e,t){const i=(0,p.Ue)();return(0,u.a)(i,e,t)}(e.targetRenderSpace,n);r.targetVector=a;const o=new Array,l=new Array;for(let d=0;d<s.numActiveFaces;d++)(0,V.Iu)(Wt,s.viewshedViewMatrices[d],n),o.push(...Wt),Bt(s.viewshedProjectionMatrices[d],Wt,Yt),l.push(...Yt);return r.viewMatrices=o,r.projectionMatrices=l,r.volumeOffset=(null===(i=this.selectedViewshed)||void 0===i?void 0:i.call(this))===e.viewshed?function(e,t,i){if(null==e)return 0;const{observerRenderSpace:s,targetRenderSpace:r}=e,n=(0,u.j)(i,s)>(0,u.j)(i,r)?e.observer:e.target;return t.pixelSizeAt(n)}(e,this.view,t.eye):0,r}get test(){return{viewsheds:this._viewsheds,shadowMap:this._shadowMap,viewshedsInView:this._viewshedsInView}}};function Bt(e,t,i){const s=(0,p.al)(.5,.5,.5);return(0,V.vc)(i,s),(0,V.bA)(i,i,s),(0,V.dC)(i,i,e),(0,V.dC)(i,i,t),i}(0,s._)([(0,h.Cb)()],Zt.prototype,"_techniques",void 0),(0,s._)([(0,h.Cb)()],Zt.prototype,"selectedViewshed",void 0),(0,s._)([(0,h.Cb)()],Zt.prototype,"shadowMap",null),(0,s._)([(0,h.Cb)()],Zt.prototype,"hasViewsheds",null),(0,s._)([(0,h.Cb)()],Zt.prototype,"_contentPixelRatio",null),(0,s._)([(0,h.Cb)()],Zt.prototype,"_viewshedsInView",null),(0,s._)([(0,h.Cb)()],Zt.prototype,"consumes",void 0),(0,s._)([(0,h.Cb)()],Zt.prototype,"produces",void 0),Zt=(0,s._)([(0,c.j)("esri.views.3d.webgl-engine.lib.Viewshed")],Zt);const Gt=(0,p.Ue)(),Wt=(0,y.Ue)(),Yt=(0,y.Ue)();var qt=i(70209);let Xt=class extends((0,f.p)(n.Z)){constructor(e){super(e),this.type="viewshed-view-3d",this.analysis=null,this.tool=null,this._selectedViewshed=null,this.viewshedComputedDataHandles=null,this._placementTask=null,this._viewshedRenderer=null,this._intersector=null}get selectedViewshed(){return this._selectedViewshed}set selectedViewshed(e){this._unselectOtherViewsheds(e),this._selectedViewshed=e}get selectedViewshedComputedData(){var e;return null===(e=this.tool)||void 0===e?void 0:e.selectedViewshedComputedData}initialize(){const e=this.view;this._viewshedRenderer=new Zt({view:e,selectedViewshed:()=>{var e,t;return null!==(e=this.selectedViewshed)&&void 0!==e?e:null===(t=this.tool)||void 0===t?void 0:t.stagedViewshed}}),this._intersector=(0,yt.Z8)(this.view.state.viewingMode),this._intersector.options.hud=!1,this._intersector.options.store=Ct.eC.MIN,this.viewshedComputedDataHandles=(0,d.wZ)((()=>this.analysis.viewsheds),(t=>{const i=new bt({renderCoordsHelper:e.renderCoordsHelper,viewshed:t}),s=Symbol();return this.addHandles([(0,d.YP)((()=>{var e;return{valid:i.isValid(),canProject:(0,v.canProjectWithoutEngine)(null===(e=i.observer)||void 0===e?void 0:e.spatialReference,this.view.spatialReference)||(0,v.isLoaded)()}}),((e,t)=>{let{valid:s,canProject:r}=e;this.visible&&(s&&r?this._addViewshedsToRenderer(i):(null===t||void 0===t?void 0:t.valid)&&(null===t||void 0===t?void 0:t.canProject)&&this._removeViewshedsFromRenderer(i),r||(0,w.e)(this.analysis,i.observer.spatialReference,o.Z.getLogger(this)))}),d.nn),(0,d.YP)((()=>[e.state.camera,e.slicePlane,i.viewshed.observer,i.targetRenderSpace,i.verticalFieldOfView,i.horizontalFieldOfView,i.feature]),(()=>{this._updateObserverFromFeature(e,i)}),d.nn)]),{viewshedComputedData:i,remove:()=>{this.removeHandles(s),this._removeViewshedsFromRenderer(i),i.destroy()}}})),this._analysisVisualization=new _t({view:e,analysisViewData:this,isDecoration:!this.parent}),this.addHandles([(0,d.YP)((()=>this.visible),(e=>{const t=this.viewshedComputedDataHandles;if(null==t)return;e||(this.selectedViewshed=null);const i=t.map((e=>e.viewshedComputedData)).filter((e=>e.isValid())).toArray();e?this._addViewshedsToRenderer(i):this._removeViewshedsFromRenderer(i)})),(0,d.YP)((()=>e.renderCoordsHelper),(e=>{var t;null===(t=this.viewshedComputedDataHandles)||void 0===t||t.forEach((t=>{let{viewshedComputedData:i}=t;return i.renderCoordsHelper=e}))})),(0,qt.Lp)(this,$e),(0,d.gx)((()=>this.interactive),(()=>{this._unselectOtherViewsheds(this.selectedViewshed)}),d.tX)])}destroy(){this._placementTask=(0,l.IM)(this._placementTask),(0,qt.Yq)(this),this._analysisVisualization=(0,l.SC)(this._analysisVisualization);const e=this.viewshedComputedDataHandles;null!=e&&this._removeViewshedsFromRenderer(e.map((e=>e.viewshedComputedData)).toArray())}async createViewsheds(e){return this._placementTask=(0,l.IM)(this._placementTask),this._placementTask=(0,qt.Er)(this,e),null!=this.tool&&this.tool.createViewsheds(),await this._placementTask.promise}_addViewshedsToRenderer(e){this._viewshedRenderer.updateViewsheds({adds:e})}_removeViewshedsFromRenderer(e){this._viewshedRenderer.updateViewsheds({removes:e})}_updateObserverFromFeature(e,t){const i=t.observerRenderSpace,s=t.targetRenderSpace,n=(0,u.c)((0,p.Ue)(),i),a={observer:i,observerSurfaceNormal:null,observerAdjusted:n,observerFeatureId:(0,r.pD)(t.feature),target:s,targetSurfaceNormal:null,targetAdjusted:(0,u.c)((0,p.Ue)(),s),targetFeatureId:null};(0,r.NS)(e,this._intersector,a,(e=>Math.min(e,.05*t.farDistanceRenderSpace))),t.observerRenderSpaceOverride=(0,u.p)(n,i)?null:n}_unselectOtherViewsheds(e){if(null!=e)for(const t of this.view.tools.items)t!==this.tool&&t instanceof $e&&(t.analysisViewData.selectedViewshed=null)}get test(){}};(0,s._)([(0,h.Cb)({readOnly:!0})],Xt.prototype,"type",void 0),(0,s._)([(0,h.Cb)({constructOnly:!0,nonNullable:!0})],Xt.prototype,"analysis",void 0),(0,s._)([(0,h.Cb)()],Xt.prototype,"tool",void 0),(0,s._)([(0,h.Cb)()],Xt.prototype,"_selectedViewshed",void 0),(0,s._)([(0,h.Cb)()],Xt.prototype,"selectedViewshed",null),(0,s._)([(0,h.Cb)()],Xt.prototype,"selectedViewshedComputedData",null),(0,s._)([(0,h.Cb)()],Xt.prototype,"viewshedComputedDataHandles",void 0),(0,s._)([(0,h.Cb)()],Xt.prototype,"_analysisVisualization",void 0),(0,s._)([(0,h.Cb)()],Xt.prototype,"_placementTask",void 0),(0,s._)([(0,h.Cb)()],Xt.prototype,"_viewshedRenderer",void 0),Xt=(0,s._)([(0,c.j)("esri.views.3d.analysis.ViewshedAnalysisView3D")],Xt);const Qt=Xt},33906:(e,t,i)=>{i.d(t,{G:()=>n,e:()=>a});var s=i(79803),r=i(77648);function n(e,t,i){var n;let a=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const o=(0,s.tryProjectWithZConversion)(e,t);return null==o?null:(o.hasZ&&!a||null==i||(o.z=null!==(n=(0,r.KO)(i,o))&&void 0!==n?n:0),o)}function a(e,t,i){i.warnOnce("Failed to project analysis geometry (id: '".concat(e.id,"'), projection from spatial reference (wkid: '").concat(t.wkid,"') to view spatial reference is not supported. Projection may be possible after calling projection.load()."))}},33837:(e,t,i)=>{i.d(t,{r:()=>u});var s=i(29134),r=i(7025),n=i(32035),a=i(12400),o=i(86361),l=i(52168),d=i(79685),h=i(56529),c=i(58901);class u extends l._{constructor(e,t){super(e),this._hasExternalMaterial=!1,this._hasExternalMaterial=null!=t,this._material=null!=t?t:new c.U({width:1,color:(0,o.al)(1,0,1,1),stipplePreferContinuous:!0,isClosed:!1,falloff:0,innerWidth:1,hasPolygonOffset:!1,renderOccluded:h.yD.OccludeAndTransparent,isDecoration:!!e.isDecoration,writeDepth:!0}),this.applyProperties(e)}setGeometryFromPoint(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3;const i=(0,a.Ue)();this.view.renderCoordsHelper.toRenderCoords(e,i)&&this.setGeometryFromRenderSpacePoint(i,t)}setGeometryFromRenderSpacePoint(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3;this.geometry=[[[e[0]-t,e[1],e[2]],[e[0]+t,e[1],e[2]]],[[e[0],e[1]-t,e[2]],[e[0],e[1]+t,e[2]]],[[e[0],e[1],e[2]-t],[e[0],e[1],e[2]+t]]]}setGeometryFromExtent(e){const t=this.view.spatialReference,i=(0,a.Ue)(),s=(0,a.Ue)(),r=100,o=[];(0,n.i)(i,e[0],e[1],r),this.view.renderCoordsHelper.toRenderCoords(i,t,s),o.push([s[0],s[1],s[2]]),(0,n.i)(i,e[2],e[1],r),this.view.renderCoordsHelper.toRenderCoords(i,t,s),o.push([s[0],s[1],s[2]]),(0,n.i)(i,e[2],e[3],r),this.view.renderCoordsHelper.toRenderCoords(i,t,s),o.push([s[0],s[1],s[2]]),(0,n.i)(i,e[0],e[3],r),this.view.renderCoordsHelper.toRenderCoords(i,t,s),o.push([s[0],s[1],s[2]]),(0,n.i)(i,e[0],e[1],r),this.view.renderCoordsHelper.toRenderCoords(i,t,s),o.push([s[0],s[1],s[2]]),(0,n.i)(i,e[0],e[1],r),this.view.renderCoordsHelper.toRenderCoords(i,t,s),o.push([s[0],s[1],s[2]]),this.geometry=[o]}setGeometryFromFrustum(e){const t=[];e.lines.forEach((e=>{t.push([e.origin[0],e.origin[1],e.origin[2]]),t.push([e.endpoint[0],e.endpoint[1],e.endpoint[2]])})),this.geometry=[t]}setGeometryFromBoundedPlane(e){const t=[],i=e.origin,s=e.basis1,r=e.basis2,n=.5,o=(0,a.Ue)(),l=(0,a.Ue)(),d=(0,a.Ue)(),h=(0,a.Ue)();o[0]=i[0]-s[0]*n-r[0]*n,o[1]=i[1]-s[1]*n-r[1]*n,o[2]=i[2]-s[2]*n-r[2]*n,l[0]=i[0]-s[0]*n+r[0]*n,l[1]=i[1]-s[1]*n+r[1]*n,l[2]=i[2]-s[2]*n+r[2]*n,d[0]=i[0]+s[0]*n+r[0]*n,d[1]=i[1]+s[1]*n+r[1]*n,d[2]=i[2]+s[2]*n+r[2]*n,h[0]=i[0]+s[0]*n-r[0]*n,h[1]=i[1]+s[1]*n-r[1]*n,h[2]=i[2]+s[2]*n-r[2]*n,t.push([o[0],o[1],o[2]]),t.push([l[0],l[1],l[2]]),t.push([d[0],d[1],d[2]]),t.push([h[0],h[1],h[2]]),t.push([o[0],o[1],o[2]]),this.geometry=[t]}setGeometryFromSegment(e){const t=e.endRenderSpace;this.transform=(0,s.vc)(p,t);const{points:i}=e.createRenderGeometry(t,this.view.renderCoordsHelper);this.geometry=[i]}setGeometryFromSegments(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:a.AG;this.transform=(0,s.vc)(p,t),this.geometry=e.map((e=>e.createRenderGeometry(t,this.view.renderCoordsHelper).points))}getTransformedGeometry(){return null==this._geometry?null:this._geometry.map((e=>e.map((e=>(0,n.t)((0,a.Ue)(),e,this.transform)))))}get renderOccluded(){return this._material.parameters.renderOccluded}set renderOccluded(e){this._material.setParameters({renderOccluded:e})}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.recreateGeometry()}get width(){return this._material.parameters.width}set width(e){this._material.setParameters({width:e})}get color(){return this._material.parameters.color}set color(e){const t=1===e[3];this._material.setParameters({color:e,writeDepth:t})}get innerWidth(){return this._material.parameters.innerWidth}set innerWidth(e){this._material.setParameters({innerWidth:e})}get innerColor(){return this._material.parameters.innerColor}set innerColor(e){this._material.setParameters({innerColor:e})}get stipplePattern(){return this._material.parameters.stipplePattern}set stipplePattern(e){null!=this._material&&this._material.setParameters({stipplePattern:e})}get stippleOffColor(){return this._material.parameters.stippleOffColor}set stippleOffColor(e){this._material.setParameters({stippleOffColor:e})}get stipplePreferContinuous(){return this._material.parameters.stipplePreferContinuous}set stipplePreferContinuous(e){this._material.setParameters({stipplePreferContinuous:e})}get falloff(){return this._material.parameters.falloff}set falloff(e){this._material.setParameters({falloff:e})}get polygonOffset(){return this._material.parameters.hasPolygonOffset}set polygonOffset(e){this._material.setParameters({hasPolygonOffset:e})}createExternalResources(){}destroyExternalResources(){}createGeometries(e){for(const t of(0,d.c)(this.geometry)){const i=(0,d.Y)(this._material,t);e.addGeometry(i)}}forEachExternalMaterial(e){this._hasExternalMaterial||e(this._material)}}const p=(0,r.Ue)()},79685:(e,t,i)=>{i.d(t,{Y:()=>w,c:()=>g});var s=i(13611),r=i(6644),n=i(86361),a=i(83448),o=i(96334),l=i(86372),d=i(38461),h=i(39406),c=i(50951),u=i(91526),p=i(79100),v=i(2952),f=i(4760);function w(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const r=[],w=t.mapPositions;!function(e,t){const{attributeData:{position:i},removeDuplicateStartEnd:s}=e,r=function(e){const t=e.length;return e[0]===e[t-3]&&e[1]===e[t-2]&&e[2]===e[t-1]}(i)&&s,n=i.length/3-(r?1:0),a=new Array(2*(n-1)),o=r?i.slice(0,-3):i;let l=0;for(let d=0;d<n-1;d++)a[l++]=d,a[l++]=d+1;t.push([f.T.POSITION,new u.a(o,a,3,r)])}(t,r);const g=r[0][1].data,b=r[0][1].indices.length,V=(0,h.LE)(b);return function(e,t,i){if(null!=e.attributeData.colorFeature)return;const s=e.attributeData.color;t.push([f.T.COLOR,new u.a(null!==s&&void 0!==s?s:n.hq,i,4)])}(t,r,V),function(e,t,i){var s;null==e.attributeData.sizeFeature&&t.push([f.T.SIZE,new u.a([null!==(s=e.attributeData.size)&&void 0!==s?s:1],i,1,!0)])}(t,r,V),function(e,t,i){e.attributeData.normal&&t.push([f.T.NORMAL,new u.a(e.attributeData.normal,i,3)])}(t,r,V),function(e,t,i){null!=e.attributeData.colorFeature&&t.push([f.T.COLORFEATUREATTRIBUTE,new u.a([e.attributeData.colorFeature],i,1,!0)])}(t,r,V),function(e,t,i){null!=e.attributeData.sizeFeature&&t.push([f.T.SIZEFEATUREATTRIBUTE,new u.a([e.attributeData.sizeFeature],i,1,!0)])}(t,r,V),function(e,t,i){null!=e.attributeData.opacityFeature&&t.push([f.T.OPACITYFEATUREATTRIBUTE,new u.a([e.attributeData.opacityFeature],i,1,!0)])}(t,r,V),function(e,t,i){if(null==e.overlayInfo||e.overlayInfo.renderCoordsHelper.viewingMode!==c.JY.Global||!e.overlayInfo.spatialReference.isGeographic)return;const r=(0,l.bg)(i.length),n=(0,a.Iu)(e.overlayInfo.spatialReference);for(let s=0;s<r.length;s+=3)(0,o.gH)(i,s,r,s,n);const h=i.length/3,p=(0,d.xx)(h+1);let v=m,w=_,g=0,b=0;(0,s.t8)(v,r[b++],r[b++]),b++,p[0]=0;for(let a=1;a<h+1;++a)a===h&&(b=0),(0,s.t8)(w,r[b++],r[b++]),b++,g+=(0,s.TK)(v,w),p[a]=g,[v,w]=[w,v];t.push([f.T.DISTANCETOSTART,new u.a(p,t[0][1].indices,1,!0)])}(t,r,g),new v.Z(e,r,w,p.U.Line,i)}const m=(0,r.Ue)(),_=(0,r.Ue)();function g(e,t){if(null==e||0===e.length)return[];const i=[];return e.forEach((e=>{const s=e.length,r=(0,l.bg)(3*s);e.forEach(((e,t)=>{r[3*t]=e[0],r[3*t+1]=e[1],r[3*t+2]=e[2]}));const n={attributeData:{position:r,normal:t},removeDuplicateStartEnd:!1};i.push(n)})),i}},76284:(e,t,i)=>{i.d(t,{c:()=>c,u:()=>u});var s,r=i(30168),n=i(29134),a=i(7025),o=i(12400),l=i(96415),d=i(98634),h=i(8654);class c extends d.K{constructor(){super(...arguments),this.localOrigin=(0,o.ll)()}}function u(e){e.include(l.GZ),e.fragment.uniforms.add(new h.g("inverseViewMatrix",((e,t)=>{const i=(0,n.Iu)((0,a.Ue)(),t.camera.viewMatrix,e.localOrigin);return(0,n.iS)(i,i)}))).code.add((0,d.H)(s||(s=(0,r.Z)(["vec4 reconstructLocalPosition(vec2 coord, float linearDepth) {\nvec4 cameraSpace = vec4(reconstructPosition(coord, linearDepth), 1.0);\nreturn inverseViewMatrix * cameraSpace;\n}"]))))}},11983:(e,t,i)=>{i.d(t,{c:()=>n});var s=i(56529),r=i(42235);class n extends s.F5{intersect(e,t,i,s,n,a){return(0,r.Bw)(e,i,s,n,void 0,a)}}},86700:(e,t,i)=>{i.d(t,{Dp:()=>o,z5:()=>a});const s={dash:[4,3],dot:[1,3],"long-dash":[8,3],"short-dash":[4,1],"short-dot":[1,1]},r={dash:s.dash,"dash-dot":[...s.dash,...s.dot],dot:s.dot,"long-dash":s["long-dash"],"long-dash-dot":[...s["long-dash"],...s.dot],"long-dash-dot-dot":[...s["long-dash"],...s.dot,...s.dot],none:null,"short-dash":s["short-dash"],"short-dash-dot":[...s["short-dash"],...s["short-dot"]],"short-dash-dot-dot":[...s["short-dash"],...s["short-dot"],...s["short-dot"]],"short-dot":s["short-dot"],solid:null},n=8;function a(e){return{pattern:[e,e],pixelRatio:2}}function o(e){return"style"===(null===e||void 0===e?void 0:e.type)?function(e){return null!=e?function(e,t){return null==e?e:{pattern:e.slice(),pixelRatio:t}}(r[e],n):null}(e.style):null}},70209:(e,t,i)=>{i.d(t,{Er:()=>o,Lp:()=>l,Yq:()=>d});var s=i(14921),r=i(92026),n=i(66978),a=i(94172);function o(e,t){e.interactive=!0;const{tool:i,view:o}=e;o.activeTool=i;let l=(0,n.fu)(t,(()=>{o.activeTool===i&&(o.activeTool=null)}));return(0,s.vr)((async e=>{await(0,a.N1)((()=>null==i||!i.active),e),l=(0,r.hw)(l)}),t)}function l(e,t){return(0,a.YP)((()=>e.interactive),(()=>function(e,t){e.interactive?function(e,t){d(e);const{view:i,analysis:s}=e,r=new t({view:i,analysis:s,analysisViewData:e});e.tool=r,i.tools.add(r)}(e,t):d(e)}(e,t)),a.tX)}function d(e){const{view:t,tool:i}=e;null!=i&&(t.tools.remove(i),e.tool=null)}},86509:(e,t,i)=>{i.d(t,{f:()=>o});var s=i(27366),r=i(94172),n=(i(32718),i(93169),i(84936),i(10064),i(69912)),a=i(45900);let o=class extends a.m{constructor(e){super(e)}initialize(){this.addHandles((0,r.YP)((()=>this.analysisViewData.visible),(e=>this.visible=e),r.tX))}deactivate(){this.onDeactivate(),this.created||this.analysis.clear()}resetCreated(){this._set("created",!1)}};o=(0,s._)([(0,n.j)("esri.views.interactive.AnalysisToolBase")],o)},81298:(e,t,i)=>{i.d(t,{w:()=>n});var s=i(88153),r=i(54463);function n(e){const t=(0,s.Z8)(e);return t.options.store=r.eC.MIN,t.options.excludeLabels=!0,t}},87888:(e,t,i)=>{i.d(t,{G7:()=>u,Kj:()=>d,Lk:()=>c,Sn:()=>l,T6:()=>h});var s=i(63780),r=i(42537),n=i(77427),a=i(1614),o=i(67750);const l={redo:"r",undo:"z",center:"Alt",constraint:"Shift",cancel:"Escape",delete:["Backspace","Delete"],complete:"Enter",vertexAdd:"f",pan:" "},d={toggle:"Control"},h={enterInputMode:"Tab",commit:"Enter",discard:"Escape",next:"Tab"},c={moveUp:{key:"ArrowUp",modifier:"Shift",repeats:!0},moveDown:{key:"ArrowDown",modifier:"Shift",repeats:!0},moveLeft:{key:"ArrowLeft",modifier:"Shift",repeats:!0},moveRight:{key:"ArrowRight",modifier:"Shift",repeats:!0},scaleUp:{key:"+",modifier:"Shift"},scaleDown:{key:"-",modifier:"Shift"},factorModifier:{key:o.C,continuePropagation:!0},toggleOpacity:"t",preserveAspectRatio:{key:"Shift",continuePropagation:!0},rotateIncrements:{key:"Shift",continuePropagation:!0},undo:"z",redo:"r"};class u{constructor(){this._bindings=new Map}add(e,t){return this.addToggle(e,(e=>{"key-down"===e.type&&t(e)}))}addToggle(e,t){const i=p.fromDefinition(e,t),a=(0,n.s1)(this._bindings,i.key,(()=>[]));return a.push(i),(0,r.kB)((()=>(0,s.Od)(a,i)))}register(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:a.f.WIDGET;return(0,r.AL)([e.on("key-down",(t=>this.dispatch(e.inputManager,t)),t),e.on("key-up",(t=>this.dispatch(e.inputManager,t)),t)])}dispatch(e,t){const i=t.key,s=this._bindings.get(i);if(s)for(const r of s)r.process(e,t)}}class p{constructor(e,t,i,s,r){this.key=e,this.modifiers=t,this.repeats=i,this.continuePropagation=s,this.callback=r}process(e,t){if(!(t.key!==this.key||"repeat"in t&&t.repeat&&!this.repeats)){for(const t of this.modifiers)if(!e.isModifierKeyDown(t))return;this.continuePropagation||t.stopPropagation(),this.callback(t)}}static fromDefinition(e,t){if("string"==typeof e)return new p(e,[],!1,!1,t);const{key:i,modifier:s,repeats:r,continuePropagation:n}=e;return new p(i,s?Array.isArray(s)?s:[s]:[],!!r,!!n,t)}}},94163:(e,t,i)=>{i.d(t,{SP:()=>s,UG:()=>h,dU:()=>d,k0:()=>o,xO:()=>l});i(16889);var s,r=i(13611),n=i(6644);function a(e,t){return e[0]*t[1]-e[1]*t[0]}function o(e,t,i,s){let n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:i;return(0,r.$X)(u,s,i),(0,r.$X)(v,t,n),function(e,t,i){const s=(0,r.AK)(i,t)/(0,r.we)(i);(0,r.bA)(e,i,s)}(f,v,u),(0,r.IH)(e,n,f)}function l(e,t,i,s){(0,r.$X)(u,t,i);const n=s/(0,r.kE)(u);return(0,r.od)(e,i,u,n)}function d(e,t){const i=e.start,n=e.end,o=t.start,l=t.end,d=(0,r.$X)(u,n,i),h=(0,r.$X)(p,l,o),w=a(d,h);if(Math.abs(w)<=c)return[];const m=(0,r.$X)(v,i,o),_=a(h,m)/w,g=a(d,m)/w;if(_>=0){if(g>=0||t.type===s.LINE)return[(0,r.od)(f,i,d,_)]}else if(e.type===s.LINE&&(g>=0||t.type===s.LINE))return[(0,r.od)(f,i,d,_)];return[]}function h(e,t,i){const n=[],a=(0,r.$X)(u,e.end,e.start),o=(0,r.$X)(p,e.start,t),l=(0,r.we)(a),d=2*(0,r.AK)(a,o),h=d*d-4*l*((0,r.we)(o)-i*i);if(0===h){const t=-d/(2*l);(e.type===s.LINE||t>=0)&&n.push((0,r.od)(f,e.start,a,t))}else if(h>0){const t=Math.sqrt(h),i=(-d+t)/(2*l);(e.type===s.LINE||i>=0)&&n.push((0,r.od)(f,e.start,a,i));const o=(-d-t)/(2*l);(e.type===s.LINE||o>=0)&&n.push((0,r.od)(v,e.start,a,o))}return n}!function(e){e[e.RAY=0]="RAY",e[e.LINE=1]="LINE"}(s||(s={}));const c=1e-6,u=(0,n.Ue)(),p=(0,n.Ue)(),v=(0,n.Ue)(),f=(0,n.Ue)()}}]);
//# sourceMappingURL=3898.a25fa3c5.chunk.js.map